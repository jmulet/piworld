define(["mathquill","mathlex"],function(){function m(d){(d.match(/(\d*)(\w)/g)||[]).forEach(function(b){var c="",a="";b.split(/(\D)/g).filter(function(a){return a.length}).forEach(function(b){c+=a+b;a="*"});d=d.replace(b,c)});(d.match(/(\)\w)/g)||[]).forEach(function(b){var c="",a="";b.split(/\)/g).forEach(function(b){c+=a+b;a=")*"});d=d.replace(b,c)});return d}function n(d){for(var b in d){var c=d[b];"string"!==typeof c||c?Array.isArray(c)&&n(c):d.splice(b,1)}}function p(d,b){for(var c=0;c<d.length;c++){var a=
d[c];if("string"===typeof a){var e=a.lastIndexOf("\\"),f="";0<e&&(f=a.substring(0,e));a=a.substring(e);"\\frac"===a?(d[c]=f+"(",d.splice(c+2,0,")/("),d.splice(c+4,0,")")):0<=a.indexOf("\\sqrt[")?(console.log(" FOUND nth root "),a=a.substring(6,a.length-1),"js"===b?(d[c]=f+"Math.pow(",d.splice(c+2,0,"@1/("+a+"))")):(d[c]=f+"(",d.splice(c+2,0,")^(1/("+a+"))"))):0<=a.indexOf("\\")?(console.log("FOUND cmd "+a),a=a.replace("\\",""),"js"===b?a="Math."+a:"yacas"===b&&(a=a[0].toUpperCase()+a.substring(1).toLowerCase()),
d[c]=f+a+"(",d.splice(c+2,0,")")):a.endsWith("e^")?(console.log("FOUND cmd e^ "+a),a=a.substring(0,a.length-2)||"",a="js"===b?a+"Math.exp":"yacas"===b?a+"Exp":"maxima"===b?a+"exp":a+"e^",d[c]=f+a+"(",d.splice(c+2,0,")")):a.endsWith("^")?(console.log("FOUND cmd ^ "+a),"js"===b&&(a=a.substring(0,a.length-1)||"",a+="Math.pow"),d[c]=f+a+"(",d.splice(c+2,0,")")):console.log("??? "+a)}else Array.isArray(a)&&p(a,b)}}window.pw.app.register.directive("imMath2dInput",["$rootScope",function(d){return{restrict:"E",
replace:!0,require:["ngModel"],scope:{model:"=ngModel"},controller:["$scope",function(b){b.id="textarea_"+Math.random().toString(36).slice(2);b.add=function(c){var a=document.getElementById(b.id);if(document.selection)a.focus(),document.selection.createRange().text=c,a.focus();else if(a.selectionStart||0===a.selectionStart){var e=a.selectionStart,f=a.selectionEnd,d=a.scrollTop,h="",k=a.value.substring(0,e),l=k.trim().slice(-1);0<e&&(1<c.trim().length&&"("!==l&&"+"!==l&&"-"!==l&&"/"!==l&&"*"!==l&&
"^"!==l)&&(h="*");a.value=k+h+c+a.value.substring(f,a.value.length);a.focus();a.selectionStart=e+h.length+c.length;a.selectionEnd=e+h.length+c.length;a.scrollTop=d}else a.value+=c,a.focus();b.model=a.value}}],templateUrl:"app/shared/math2dInput.html",link:function(b,c,a){b.tabs={algebra:!0,constants:!0,symbols:!0,vectors:!0,trigonometry:!0,functions:!0};b.placeholder=a.placeholder||"Escriu l'expressi\u00f3 matem\u00e0tica ...";a.hideTabs&&a.hideTabs.split(",").forEach(function(a){b.tabs[a.trim()]=
!1});if(a.showTabs){for(var e in b.tabs)b.tabs[e]=!1;a.showTabs.split(",").forEach(function(a){b.tabs[a.trim()]=!0})}}}}]);window.app.register.filter("latex2",function(){return function(d,b){if("latex"===b)return d;console.log("vvv"+d);(d.match(/(\d*)?=\\/g)||[]).forEach(function(a){console.log("Found "+a);var b="",c="";a.split("\\").filter(function(a){return a.length}).forEach(function(a){b+=c+"\\"+a;c="*"});d=d.replace(a,b)});var c=d.replace(/,/g,"@"),c=c.replace(/\\,/g,"*").replace(/\\cdot/g,"*"),
c=c.replace(/\\pi/ig,"#").replace(/pi/ig,"#"),c=c.replace(/\\infty/ig,"#").replace(/infty/ig,"?"),c=c.replace(/\\left\(/g,"{").replace(/\\right\)/g,"}").replace(/\\/g,"\\\\"),c="['"+c.replace(/{/g,"',['").replace(/}/g,"'],'")+"']";console.log(c);c=eval(c);n(c);console.log(c);p(c,b);console.log(c);c=c.join(",").replace(/,/g,"").replace(/@/g,",");console.log(c);c=m(c);c="js"===b?c.replace(/#/g,"Math.PI").replace(/e/g,"Math.E").replace(/\?/g,"Number.POSITIVE_INFINITY"):"yacas"===b?c.replace(/#/g,"Pi").replace(/e/g,
"Exp(1)").replace(/\?/g,"Infinity"):"maxima"===b?c.replace(/#/g,"%pi").replace(/e/g,"%e").replace(/%exp/g,"exp").replace(/\?/g,"infinity"):c.replace(/#/g,"pi").replace(/\?/g,"infinity");c=c.replace(/{/g,"(").replace(/}/g,")");console.log(c);return c}});window.pw.app.register.filter("mathlex",function(){return function(d,b){d=m(d);d=d.replace(/Sin/g,"sin").replace(/Cos/g,"cos").replace(/Tan/g,"tan");d=d.replace(/Pi/g,"#pi").replace(/\\pi/g,"#pi").replace(/%pi/g,"#pi").replace(/Math.PI/g,"#pi");
d=d.replace(/Exp(1)/g,"#e").replace(/\\e/g,"#e").replace(/%e/g,"#e").replace(/Math.E/g,"#e");d=d.replace(/Math\./g,"");d=d.replace(/\\,/g,"*");var c="";try{var a=MathLex.parse(d),e=b;if("maxima"===b||"yacas"===b||"js"===b)e="sage";c=MathLex.render(a,e);"maxima"===b?(c=c.replace(/pi/g,"%pi").replace(/e/g,"%e"),c=c.replace(/log/g,"(1/log(10))*log"),c=c.replace(/ln/g,"log")):"latex"===b?c=c.replace(/tan/g,"tg"):"yacas"===b?(c=c.replace(/pi/g,"Pi").replace(/e/g,"Exp(1)"),c=c.replace(/sin/g,"Sin").replace(/cos/g,
"Cos").replace(/tan/g,"Tan"),c=c.replace(/sqrt/g,"Sqrt"),c=c.replace(/ln/g,"Ln"),c=c.replace(/log/g,"(1/(Ln(10)))*Ln")):"js"===b&&(c=c.replace(/pi/g,"Math.PI").replace(/e/g,"Math.E"),c=c.replace(/sin/g,"Math.sin").replace(/cos/g,"Math.cos").replace(/tan/g,"Math.tan"),c=c.replace(/sqrt/g,"Math.sqrt").replace(/ln/g,"Math.ln"));c=c.replace(/,\)/g,")")}catch(f){"latex"===b&&(c="Invalid\\, expression:"+f),console.log("mathlex: Invalid expression: ",d,f)}return c}});window.app.register.directive("mathquill",
["Session","$timeout","$interval",function(d,b,c){var a=MathQuill.getInterface(2);d.addCss("assets/libs/mathquill-0.10.1/mathquill.min.css");return{restrict:"E",templateUrl:"app/shared/mathquill.html",replace:!0,scope:{ngModel:"="},controller:["$scope",function(a){console.log("mathquill scope ",a);a.view={trig:!1,fun:!1,sym:!1};a.show={kyb:!1};a.setView=function(b){a.view={trig:!1,sym:!1,fun:!1};a.view[b]=!0};a.toggleView=function(b){a.view[b]=!a.view[b]};a.insert=function(b){console.log("mathquill scope ",
a);a.mathField.write(b)};a.insertCmd=function(b){console.log("mathquill scope ",a);a.mathField.cmd(b)};a.clear=function(){a.editable?a.mathField.latex(""):a.mathField.deleteblocks()};a.del=function(a){};a.move=function(b){a.mathField.move(b)}}],link:function(c,d,g){console.log("link mathquill");c.editable=null==g.embedded;c.id="mathquill_"+Math.random().toString(36).slice(2);d=g.toolBars||"*";c.SYM=0<=d.indexOf("SYM")||"*"===d;c.KYB=0<=d.indexOf("KYB")||"*"===d;c.FUN=0<=d.indexOf("FUN")||"*"===d;
c.TRIG=0<=d.indexOf("TRIG")||"*"===d;c.ngModel=c.ngModel||"";c.ngModel.id=c.id;c.tbs="simple"===(g.toolBars||"")?0:1;b(function(){var d=jQuery("#"+c.id),f;c.editable?(f=a.MathField(d[0],{handlers:{autoFunctionize:"sin cos tan sec csc cot log ln",autoCommands:"pi theta sqrt sum int oo",addCommands:{oo:["VanillaSymbol","\\infty ","&infin;"]},edit:function(){b(function(){c.ngModel.latex=f.latex();c.ngModel.text=f.text()})}}}),d.addClass("mathquill-full"),d.focus()):f=a.StaticMath(d);f.latex(c.ngModel.latex||
"");c.$watch(g.ngModel,function(){f.latex(c.ngModel.latex||"")});c.mathField=f})}}}]);window.pw.app.register.directive("imVector",["$compile",function(d){return{restrict:"E",replace:!0,scope:{v:"=ngModel"},link:function(b,c,a){a="<span><span mathjax-bind='v.label'>({{v.x}}, {{v.y}}";b.v&&"undefined"!==typeof b.v.z&&(a+=", {{v.z}}");b=d(a+")</span>")(b);c.replaceWith(b)}}}]);window.app.register.directive("imVectorInput",["$compile",function(d){return{restrict:"E",replace:!0,scope:{v:"=ngModel",
disabled:"=ngDisabled"},link:function(b,c,a){a="<span><span mathjax-bind='v.label'> </span><span style='font-size:150%'>(</span><input type='text' class='matrixinput' ng-model='v.x' ng-disabled='disabled'/>, <input type='text' class='matrixinput' ng-model='v.y' ng-disabled='disabled'/>";b.v&&"undefined"!==typeof b.v.z&&(a+=", <input type='text' class='matrixinput' ng-model='v.z' ng-disabled='disabled'/>");b=d(a+"<span style='font-size:150%'>)</span></span>")(b);c.replaceWith(b)}}}]);window.app.register.directive("imMatrixInput",
["$compile",function(d){return{restrict:"E",replace:!0,scope:{matrix:"=ngModel",type:"@type",disabled:"=ngDisabled"},link:function(b,c,a){b.type||(b.type="matrix");a="</span><table border='0' cellpadding='0' cellspacing='2' class='"+b.type+"'><tbody>";a+="<tr ng-repeat='row in matrix'><td ng-repeat='item in row'><input ng-class=\"item.check===-1?'matrixinput matrixinputwrong':'matrixinput')\" type='text' ng-model='item.v'/></td>";a+="</tr></tbody><span></table>";b=d(a)(b);c.replaceWith(b)}}}]);window.app.register.directive("imZeroesInput",
["$compile",function(d){return{restrict:"E",replace:!0,scope:{zeroes:"=ngModel",bar:"@var",disabled:"=ngDisabled"},link:function(b,c,a){b.options=["max","min","other"];b.bar||(b.bar="x");a=b.bar.split(",");var e=b.bar="";a.forEach(function(a){b.bar=e+a;e=", "});b.dim=a.length;b.remove=function(a){a=b.zeroes.indexOf(a);0<=a&&b.zeroes.splice(a,1)};b.add=function(){var a={x:"",check:0};2===b.dim?a={x:"",y:"",check:0}:3===b.dim?a={x:"",y:"",z:"",check:0}:4===b.dim&&(a={x:"",y:"",z:"",t:"",check:0});b.zeroes.push(a)};
a="<table border='0' cellpadding='0' cellspacing='2'><tbody><tr ng-repeat='root in zeroes'>"+("<td><katex>"+b.bar+"</katex><sub>{{$index+1}}</sub> = ");a+="<input type='text' ng-model='root.x' ng-disabled='disabled' class='rootinput' ng-show='dim>=1'/>";a+="<input type='text' ng-model='root.y' ng-disabled='disabled' class='rootinput' ng-show='dim>=2'/>";a+="<input type='text' ng-model='root.z' ng-disabled='disabled' class='rootinput' ng-show='dim>=3'/>";a+="<input type='text' ng-model='root.t' ng-disabled='disabled' class='rootinput' ng-show='dim>=4'/>";
a+="<button ng-click='remove(root)' class='btn btn-xs btn-danger' ng-disabled='disabled'>-</button>  ";a+="<img src='assets/img/cross.png' ng-show='root.check==-1'>";a+="<img src='assets/img/tick.png' ng-show='root.check==1'>";a+="</td></tr></tbody><span></table><span ng-show='zeroes.length==0'><b>No solution</b><br></span> Add <button ng-click='add()' class='btn btn-xs btn-info' ng-disabled='disabled'>+</button></td><br><small>Per a infinites solucions escriviu: <b>all</b></small>";a=d(a)(b);c.replaceWith(a)}}}]);
window.pw.app.register.directive("imPickList",["$compile",function(d){return{restrict:"E",replace:!0,scope:{v:"=ngModel",disabled:"=ngDisabled"},link:function(b,c,a){b=d("<span ng-repeat='o in v'><button ng-class=\"o.s?'btn btn-primary':'btn btn-default'\" ng-disabled='disabled' ng-click='o.s=!o.s'>{{o.x}}</button></span>")(b);c.replaceWith(b)}}}]);window.pw.app.register.directive("imExtremaInput",["$compile",function(d){return{restrict:"E",replace:!0,scope:{extrema:"=ngModel",bar:"@var",
disabled:"=ngDisabled"},link:function(b,c,a){b.bar||(b.bar="x,y");a=b.bar.split(",");var e=b.bar="";a.forEach(function(a){b.bar=e+a;e=", "});b.dim=a.length;b.remove=function(a){a=b.extrema.indexOf(a);0<=a&&b.extrema.splice(a,1)};b.add=function(){var a={x:"",check:0};2===b.dim&&(a={x:"",y:"",check:0});b.extrema.push(a)};a="<table border='0' cellpadding='0' cellspacing='2'><tbody><tr ng-repeat='root in extrema'>"+("<td><katex>"+b.bar+"</katex><sub>{{$index+1}}</sub> = ");a+="<input type='text' ng-model='root.x' ng-disabled='disabled' class='rootinput' ng-show='dim>=1'/>";
a+="<input type='text' ng-model='root.y' ng-disabled='disabled' class='rootinput' ng-show='dim>=2'/>";a+="<select ng-options='options' ng-model='root.type' ng-disabled='disabled'></select>";a+="<button ng-click='remove(root)' class='btn btn-xs btn-danger' ng-disabled='disabled'>-</button></td>";a+="<img src='assets/img/cross.png' ng-show='root.check==-1'>";a+="<img src='assets/img/tick.png' ng-show='root.check==1'>";a+="</tr></tbody><span></table><span ng-show='zeroes.length==0'><em>No extrema</em></span> Add <button ng-click='add()' class='btn btn-xs btn-info' ng-disabled='disabled'>+</button></td>";
a=d(a)(b);c.replaceWith(a)}}}]);window.pw.app.register.directive("imRuffiniInput",["$compile",function(d){return{restrict:"E",replace:!0,scope:{ruffini:"=ngModel",disabled:"=ngDisabled"},link:function(b,c,a){b.ruffini.poly||(b.ruffini.poly=["",""]);b.ruffini.div||(b.ruffini.div="");b.ruffini.calc||(b.ruffini.calc=Array(b.ruffini-1));b.ruffini.quoc||(b.ruffini.quoc=Array(b.ruffini));a="<table border='0' cellpadding='0' cellspacing='2'><tbody><tr><td style='border-left: thick double #ff0000'></td><td ng-repeat='c in ruffini.poly'>{{c}}</td>";
a+="</tr>";a+="<tr><td style='border-left: thick double #ff0000'><input type='text' ng-model='ruffini.div'/></td><td></td>";a+="<td ng-repeat='c in ruffini.calc'><input type='text' ng-model='c'/></td>";a+="</tr>";a+="<tr><td syle='border-left: thick double #ff0000; border-top: thick double #ff0000;'></td>";a+="<td style='border-top: thick double #ff0000;' ng-repeat='c in ruffini.quoc'><input type='text' ng-model='c'/></td>";a+="</tr>";a+="</tbody></table>";b=d(a)(b);c.replaceWith(b)}}}]);window.app.register.directive("autoGrow",
function(){return function(d,b,c){var a=parseInt(c.maxWidth)||1E3,e=parseInt(c.minWidth)||b.width(),f=parseInt(c.comfortZone)||10,g="",h=angular.element("<div></div>").css({position:"absolute",top:-1E4,left:-1E4,width:"auto",fontSize:b.css("fontSize"),fontFamily:b.css("fontFamily"),fontWeight:b.css("fontWeight"),letterSpacing:b.css("letterSpacing"),whitespace:"nowrap"});h.insertAfter(b);var k=function(){if(g!==(g=b.val())){var c=g.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,
"&gt;");h.html(c);var c=h.width(),c=c+f>=e?c+f:e,d=b.width();(c<d&&c>=e||c>e&&c<a)&&b.width(c);c>=a&&b.width(a)}};c.ngModel?d.$watch(c.ngModel,k):b.bind("keyup keydown keypress change",k);k()}});window.pw.app.register.directive("imFillTextGaps",["$compile",function(d){return{restrict:"E",replace:!1,scope:{userinput:"=ngModel",disabled:"=ngDisabled",expression:"=expression"},link:function(b,c,a){b.$watch("expression",function(a){var f=0,g=b.expression=a;(b.expression.match(/\?/g)||[]).forEach(function(a){b.userinput["blank"+
f]="";g=g.replace("?","<input type='text' ng-model='userinput.blank"+f+"' auto-grow ng-disabled='disabled' style='width:20px;'/>");f+=1});c.html(g);d(c.contents())(b)})}}}]);window.pw.app.register.directive("imFillMathGaps",["$compile","$timeout","Session",function(d,b,c){return{restrict:"A",replace:!1,scope:{disabled:"=ngDisabled",imFillMathGaps:"=imFillMathGaps",id:"=id"},link:function(a,d,f){c.addCss("assets/libs/mathquill/mathquill.css");d=function(c){var d=a.id,e=a.imFillMathGaps=c,e=e.replace(/\?/g,
"\\editable{}");console.log("STR IS "+e);b(function(){var a=jQuery("#"+d);a.mathquill();a.mathquill("latex",e||"")},600)};console.log(a.imFillMathGaps);d(a.imFillMathGaps);a.$watch("imFillMathGaps",d)}}}]);window.pw.app.register.directive("imKahootInput",["$compile",function(d){return{restrict:"E",replace:!1,scope:{disabled:"=ngDisabled",ngModel:"=",options:"=",done:"="},controller:["$scope",function(b){b.select=function(c){null!==b.ngModel&&("function"===typeof b.ngModel?b.ngModel(c):b.ngModel=
b.options[c])}}],link:function(b,c,a){a="red blue green orange yellow brown olive pink".split(" ");for(var e="<table border='0' cellpadding='5px' cellspacing='5px' style='width:100%'><tbody>",f=Math.floor(b.options.length/2),g=0;2>g;g++){for(var e=e+"<tr>",h=0;h<f;h++){var k=f*g+h;k<b.options.length&&(e+="<td><button ng-disabled=\"disabled\" ng-style=\"{'cursor': done?'not-allowed':'pointer', 'pointer-events': done?'none':'auto'}\" style='min-height:180px; color:white; font-size: 20pt; background-color:"+
a[k%8]+"; width:100%; height:100%;' ng-click=\"!done && select("+k+')"><span compile="options['+k+']"></span></button></td>')}e+="</tr>"}b=d(e+"</tbody></table>")(b);c.replaceWith(b)}}}]);window.pw.app.register.directive("imDynamicForm",["$compile",function(d){return{restrict:"E",replace:!1,scope:{disabled:"=ngDisabled",ngModel:"=",view:"="},controller:["$scope",function(b){b.select=function(c){b.ngModel&&b.ngModel(c)}}],link:function(b,c,a){a="";for(var e=0;e<b.view.length;e++){var f=b.view[e],
g=(f.type||"").toLowerCase();a="number"===g?a+("<span compile='view["+e+"].title'></span> <input type='number' ng-model = 'ngModel."+f.name+"'/><br>"):"textarea"===g?a+("<span compile='view["+e+"].title'></span><br> <textarea ng-model = 'ngModel."+f.name+"'></textarea><br>"):"checkbox"===g?a+("<input type='checkbox' ng-model = 'ngModel."+f.name+"'> <span compile='view["+e+"].title'></span><br>"):"combobox"===g?a+("<span compile='view["+e+"].title'></span> <select ng-model = 'ngModel."+f.name+"'><option ng-repeat='o in view["+
e+"].options' value='{{o.value}}'>{{o.label}}</option></select><br>"):a+("<span compile='view["+e+"].title'></span> <input ng-model = 'ngModel."+f.name+"'/><br>")}console.log(a);b=d(a)(b);c.replaceWith(b)}}}])});
