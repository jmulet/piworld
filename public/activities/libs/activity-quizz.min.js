(function(){var e=window.pw||{};e.QuestionPanel=function(a,c,d){var f=this;this.container=a;this.rest=a.rest;this.data=a.data;this.attempt=a.data.attempt;this.TopBar=c;this.options=d;this.id=Math.random().toString(36).substr(2);a='<div><div class="container-fluid"><div id="questionContainer'+this.id+'" class="row"></div><center>';d.showCheckBtn&&(a+='<button class="btn btn-warning glyphicon glyphicon-question-blackboard" style="display:none"><span>'+e.getI18n("HINTS")+'</span></button><button id="checkBtn'+
this.id+'" class="btn btn-primary glyphicon glyphicon-question-mark"><span>'+e.getI18n("CHECK")+"</span></button>");a+='<div id="squizzFeedback'+this.id+'" style="display:none"></div></center></div></center></div>';this.questionPanel=$(a);this.container.append(this.questionPanel);this.questionTag=this.questionPanel.find("#questionContainer"+this.id);this.hintsButton=this.questionPanel.find(".btn.btn-warning");this.checkButton=this.questionPanel.find("#checkBtn"+this.id);if(this.checkButton[0])this.checkButton.on("click",
function(b){f.checkButton.prop("disabled",!0);f.check()});this.feedbackPanel=this.questionPanel.find("#squizzFeedback"+this.id)};e.QuestionPanel.prototype={appendButton:function(a){a.insertBefore("#squizzFeedback"+this.id)},setQuestion:function(a){var c=this;this.question=a;if(a.hint||a.hints)c.hintsButton.show(),c.hintsButton.off(),c.hintsButton.on("click",function(){c.feedbackPanel.html(a.hint||a.hints);c.feedbackPanel.show();a.askHelp=!0});this.createRenderer().then(function(d){c.renderQuestion(a)})},
createRenderer:function(){var a=new $.Deferred,c=this,d=this.question;if(!d)return console.log("Upps!! question is not defined"),a.reject(),a.promise();d.options&&(this.options.shuffleOptions||d.shuffleOptions)&&d.options.shuffle();var e=[];"multiple"===d.type.trim().toLowerCase()?e.push("/activities/libs/quizzrenderer-"+(d.format||"kahoot")+".js"):0>d.type.indexOf(".js")?e.push("/activities/libs/quizzrenderer-"+(d.type||"input")+".js"):e.push(d.type);d.deps&&(e=$.merge(e,d.deps));require(e,function(b){c.renderer&&
c.renderer.destroy();c.renderer=new b(d,c.questionTag,c.checkButton);a.resolve(c.renderer)},function(b){console.log("Unable to resolve dependencies ",e,b);a.reject()});return a.promise()},feedback:function(a,c){this.feedbackPanel.show();if(c)a='<h4 style="color:'+c+';">'+a+"</h4>";else{var d=this.question;a?a=d.valid?'<h4 style="color:green;">'+a+"</h4>":'<h4 style="color:red;">'+a+"</h4>":d.valid?a='<h4 style="color:green;">'+e.getI18n("RIGHT_ANSWER")+"</h4>":(a='<h4 style="color:red;">'+e.getI18n("WRONG_ANSWER")+
"</h4>",(d=this.question.feedback)&&(a+="<div>"+d+"</div>"),a+="<div>"+e.getI18n("THE_ANSWER")+" "+this.renderer.getRightAnswer()+"</div>")}this.feedbackPanel.html(a)},renderQuestion:function(a){e.Sound.stop();var c=this;a=a||this.question;$(".side-widgets").remove();var d=62;if(1<a.scoreWeight){var f='<div class="side-widgets blink" style="float:left; left: 10px; top: '+d+'px; width:100px;"><span class="picoin"></span> <span class="lcd"> x'+a.scoreWeight+"</span></div>",d=d+45;this.questionPanel.append(f)}0<
a.extraLive&&(f='<div class="side-widgets blink" style="float:left; left: 10px; top: '+d+'px; width:100px;"><img height="40px" src="/assets/img/avatar/'+(e.getUser().uopts.avatar||0)+'.png"/> <span class="lcd"> + '+a.extraLive+"</span></div>",d+=45,this.questionPanel.append(f));a.timeout&&(f='<div class="side-widgets" style="float:left; left: 10px; top: '+d+'px; width:100px;"> <img src="/assets/img/hourglass.gif" height="40px"/> <span id="settimeout" class="lcd">'+a.timeout+"</div>",d+=45,this.questionPanel.append(f));
"undefined"===typeof a.idQuestion?(a.seconds=0,a.attempts=0,a.askHelp=!1,a.askTheory=!1,a.askAnswer=!1,c.rest?c.rest.openQuestion(this.attempt.idAttempt,a.formulation+"<br>"+(a.subformulation||""),this.renderer.getRightAnswer(),a.category||c.data.activityInfo.category||"",a.level).then(function(b){a.idQuestion=b.idQuestion;a.formulation=e.katexParser(a.formulation);"blanks"!==a.type&&(a.subformulation=e.katexParser(a.subformulation));c.renderer.render();c.checkButton&&c.checkButton.prop("disabled",
!1);e.autoRender&&e.autoRender(c.questionPanel);c.lastTime=(new Date).getTime();a.timeout&&(c.timeoutInterval=setInterval(function(){0<a.timeout?(a.timeout-=1,$("span#settimeout.lcd").text(a.timeout),10===a.timeout&&($("span#settimeout.lcd").css({color:"red"}),$("span#settimeout.lcd").addClass("blink"))):(clearInterval(c.timeoutInterval),c.checkButton&&c.checkButton.prop("disabled","true"),$(".side-widgets").remove(),c.renderer.enable(!1),a.ownscore=0,a.closed=!0,c.feedback(e.getI18n("TIME_OVER")),
c.rest&&c.rest.closeQuestion(a.idQuestion,a.seconds,a.ownscore,a.askTheory,a.askHelp,a.askAnswer),c.onWrongAttempt&&c.onWrongAttempt())},1E3))}):(c.renderer.render(),c.checkButton&&c.checkButton.prop("disabled",!1),e.autoRender&&e.autoRender(c.questionPanel))):(this.renderer.render(),this.checkButton&&this.checkButton.prop("disabled",!1),e.autoRender&&e.autoRender(c.questionPanel))},getValue:function(){this.renderer.enable(!1);return this.renderer.getValue()},check:function(){var a=this.renderer.validate();
if(a)e.GenericModal.show(e.getI18n("INVALID_INPUT"),a,1E4),this.checkButton&&this.checkButton.prop("disabled",!1);else{var c=this,d=this.question;d.attempts+=1;a=(new Date).getTime();d.seconds+=Math.floor((a-this.lastTime)/1E3);this.lastTime=a;this.renderer.enable(!1);var f=this.renderer.getValue(),b=function(b,a){c.rest&&c.rest.addAnswer(d.idQuestion,f,b);b?(c.timeoutInterval&&clearInterval(c.timeoutInterval),d.valid=!0,c.renderer.revealAnswer(),d.scoreWeight=d.scoreWeight||1,d.ownscore=Math.floor((d.score||
c.options.rightScore)*d.scoreWeight),1<d.attempts?d.ownscore=Math.floor(d.ownscore*c.options.wrongAttemptPenalty):0<d.extraLive&&c.TopBar&&c.TopBar.addLives(d.extraLive),d.closed=!0,c.feedback(e.getI18n("RIGHT_ANSWER")),c.rest&&c.rest.closeQuestion(d.idQuestion,d.seconds,d.ownscore,d.askTheory,d.askHelp,d.askAnswer),c.onRightAnswer&&c.onRightAnswer()):(d.attempts>=(d.maxAttempts||c.options.maxAttempts)?(c.timeoutInterval&&clearInterval(c.timeoutInterval),d.ownscore=0,d.closed=!0,$(".side-widgets").remove(),
c.feedback(),c.rest&&c.rest.closeQuestion(d.idQuestion,d.seconds,d.ownscore,d.askTheory,d.askHelp,d.askAnswer),c.onWrongAttempt&&c.onWrongAttempt()):(c.feedback(e.getI18n("WRONG_ANSWER")+"<br>"+e.getI18n("TRY_AGAIN")+"<br><p>"+a+"</p>"),c.renderer.enable(!0),c.checkButton&&c.checkButton.prop("disabled",!1),c.onWrongAnswer&&c.onWrongAnswer()),e.Sound.play("soundWrongAnswer"));e.autoRender&&e.autoRender(c.questionPanel)},a=this.renderer.check();"boolean"===typeof a?b(a,""):a.then?a.then(function(a){b(a.ok,
a.msg)}):a&&"object"===typeof a?b(a.ok,a.msg||""):(a=!1,b(!1,"No s'ha pogut comprovar la resposta"));return a}}};e.SimpleQuizz=function(a,c,d,f){c.empty();c.append('<div class="before"></div><div class="after"></div>');$(".background-panel").hide();var b=this;this.json=d;this.container=c;this.rest=c.rest;this.resources=c.resources;this.data=c.data;this.attempt=c.data.attempt;this.deferEndGame=a;this.currentLevel=this.overallIndex=this.currentIndex=this.overall=this.lastTime=0;this.options=$.extend({shuffleQuestions:!1,
shuffleOptions:!1,maxAttempts:1,rightScore:20,wrongAttemptPenalty:0.5,canSkipQuestions:!1,canSkipWrongQuestions:!1,maxLives:4,game:"classical"},f);$.each(this.json,function(a,c){b.options.shuffleQuestions&&c.shuffle();b.options.maxQuestionsLevel&&(b.options.maxQuestionsLevel[a]&&b.options.maxQuestionsLevel[a]<c.length)&&c.splice(0,c.length-b.options.maxQuestionsLevel[a]);b.overall+=c.length});e.urlVars.test&&(this.options.maxLives=1E3,this.options.maxAttempts=1E3);this.TopBar=new e.TopBar(function(a){b.attempt.done=
!1;b.updateAttempt();b.TopBar.hide();b.container.hide();e.Sound.play("soundGameOver");b.deferEndGame.resolve()});this.TopBar.setLives(this.options.maxLives);this.nextButton=$('<button id="nextBtn" class="btn btn-primary glyphicon glyphicon-arrow-right" style="display:none"><span>'+e.getI18n("NEXT")+"</span></button>");if("all"===this.options.game){console.log("ALL GAME");this.options.showCheckBtn=!1;var g=[];$.each(this.json,function(a,c){b.container.append('<h1 style="color:white; background-color:black;margin-top:50px;"><b>'+
e.getI18n("LEVEL")+" "+(a+1)+"</b></h1>");$.each(c,function(a,c){var d=new e.QuestionPanel(b.container,b.TopBar,b.options);d.setQuestion(c);g.push(d);b.container.append("<hr>")})});a=$("<center><div></div></center>");c=$('<button id="checkBtn" class="btn btn-success glyphicon glyphicon-arrow-right"><span>'+e.getI18n("CHECKS")+"</span></button>");a.append(c);this.container.append(a);this.numAttempts=0;c.on("click",function(){b.numAttempts+=1;var a=0,c=[],d;$.each(g,function(b,e){var f=e.check();"undefined"===
typeof f&&(d=!0);f.then?c.push(f):"object"===typeof f&&f.ok?a+=1:"boolean"===typeof f&&f&&(a+=1)});if(!d){var f=function(){a<g.length?b.numAttempts<b.options.maxAttempts&&0<b.TopBar.getLives()?(b.updateAttempt(),b.TopBar.addLives(-1),e.GenericModal.show(e.getI18n("CONGRATULATIONS")+"!","Tens "+a+" de "+g.length+" correctes. Intentau de nou. Et queden "+(b.options.maxAttempts-b.numAttempts)+" intents.",4E3)):(b.attempt.done=!1,b.updateAttempt(),b.TopBar.hide(),e.GameOver.show(),b.deferEndGame.resolve(),
$(".background-panel").show()):(b.attempt.done=!0,b.updateAttempt(),e.Sound.play("soundRightAnswer"),b.TopBar.hide(),b.container.fireworks(),e.GenericModal.show(e.getI18n("CONGRATULATIONS")+"!","Les has encertades totes amb "+b.numAttempts+" intents.",null,function(){$(".background-panel").show();b.deferEndGame.resolve()}))};c.length?$.when.apply($,c).done(function(){var b=Array.prototype.slice.call(arguments);$.each(b,function(b,c){c&&"object"===typeof c&&c.ok?a+=1:"boolean"===typeof c&&c&&(a+=1)});
f()}):f()}})}else"level"===this.options.game?(console.log("LEVEL GAME"),this.options.showCheckBtn=!1,a=$("<center><div></div></center>"),c=$('<button id="checkBtn" class="btn btn-success glyphicon glyphicon-arrow-right"><span>'+e.getI18n("CHECKS")+"</span></button>"),a.append(c),a.append(nextButton),this.container.append(a),this.numAttempts=0,c.on("click",function(){b.numAttempts+=1;var a=0;$.each(g,function(b,c){c.check()&&(a+=1)});a<g.length?b.numAttempts<b.options.maxAttempts&&0<b.TopBar.getLives()?
(b.updateAttempt(),b.TopBar.addLives(-1),e.GenericModal.show(e.getI18n("CONGRATULATIONS")+"!","Tens "+a+" de "+g.length+" correctes. Intentau de nou. Et queden "+(b.options.maxAttempts-b.numAttempts)+" intents.",4E3)):(b.attempt.done=!1,b.updateAttempt(),b.TopBar.hide(),e.GameOver.show(),b.deferEndGame.resolve(),$(".background-panel").show()):(b.attempt.done=!0,b.updateAttempt(),e.Sound.play("soundRightAnswer"),b.TopBar.hide(),b.container.fireworks(),e.GenericModal.show(e.getI18n("CONGRATULATIONS")+
"!","Les has encertades totes amb "+b.numAttempts+" intents.",null,function(){$(".background-panel").show();b.deferEndGame.resolve()}))})):(console.log("CLASSICAL GAME"),this.options.showCheckBtn=!0,this.questionPanel=new e.QuestionPanel(this.container,this.TopBar,this.options),this.questionPanel.appendButton(this.nextButton),this.questionPanel.onRightAnswer=function(){b.nextButton.show();e.Sound.play("soundRightAnswer");b.container.fireworks()},this.questionPanel.onWrongAnswer=function(){b.options.canSkipWrongQuestion&&
b.nextButton.show()},this.questionPanel.onWrongAttempt=function(){b.TopBar.addLives(-1);0<b.TopBar.getLives()?b.nextButton.show():(b.attempt.done=!1,b.TopBar.hide(),e.GameOver.show(),$(".background-panel").show(),b.deferEndGame.resolve())},this.currentLevel=this.data.maxLevelUser-1,0<this.currentLevel&&1<this.json.length&&e.GenericModal.show(e.getI18n("YOUR_LEVEL")+":",e.getI18n("LEVEL")+" "+(b.currentLevel+1),2E3),this.questionPanel.setQuestion(this.json[this.currentLevel][this.currentIndex]),this.nextButton.on("click",
function(){b.updateAttempt();b.questionPanel.feedbackPanel.hide();b.nextButton.hide();b.overallIndex+=1;if(b.currentIndex<b.json[b.currentLevel].length-1){b.currentIndex+=1;b.questionPanel.setQuestion(b.json[b.currentLevel][b.currentIndex]);var a=Math.floor(100*(b.overallIndex+1)/b.overall),c=e.getI18n("LEVEL")+" "+(b.currentLevel+1)+" : "+(b.currentIndex+1)+" / "+b.json[b.currentLevel].length;b.TopBar.setProgress(a,c)}else b.currentLevel<b.json.length-1?(b.currentLevel+=1,e.GenericModal.show(e.getI18n("CONGRATULATIONS")+
"!",e.getI18n("LEVEL")+" "+(b.currentLevel+1),1500),b.currentIndex=0,b.questionPanel.setQuestion(b.json[b.currentLevel][b.currentIndex]),a=Math.floor(100*(b.overallIndex+1)/b.overall),c=e.getI18n("LEVEL")+" "+(b.currentLevel+1)+" : "+(b.currentIndex+1)+" / "+b.json[b.currentLevel].length,b.TopBar.setProgress(a,c)):(b.attempt.done=!0,b.TopBar.hide(),e.Sound.play("soundGameOver"),$(".background-panel").show(),b.deferEndGame.resolve())}))};e.SimpleQuizz.prototype={updateAttempt:function(){var a=0;$.each(this.json,
function(c,d){$.each(d,function(c,b){a+=b.ownscore?b.ownscore:0})});this.attempt.score=a;this.attempt.level=this.currentLevel+1;this.rest.updateAttempt(this.attempt);this.TopBar.setScore(this.attempt.score)}}})();
