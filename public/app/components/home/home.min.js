var pwcUnitsCtrl=function(l,a,q,m,n,c,p,e,r){var b=this;b.tgs={edition:!1};b.USER_ROLES=c;b.currentYear=pw.currentYear;b.showAllIn=function(a){a.showAll=!0};b.noGhostFilter=function(a){return!a.gopts.isGhost};b.reload=function(a){b.pwcID&&(b.group?q.post("/rest/assignments/queryasgn",{idGroup:b.group.idGroup,idUser:b.user.id},!0).then(function(a){a.data.forEach(function(a){switch(a.visible){case 0:a.collapsed=!0;break;case 1:a.collapsed=!0;a.showAll=!1;break;case 2:a.collapsed=!1;a.showAll=b.group.currentUnit===
a.id;break;default:a.collapsed=!1,a.showAll=!0}a.assignments.forEach(function(a){a.fromDate&&(a.fromDate=new Date(a.fromDate));a.toDate&&(a.toDate=new Date(a.toDate))})});b.units=a.data;b.units_collapse_ini=a.data.map(function(a){return{collapsed:a.collapsed,showAll:a.showAll}});e.assignmentsCache[b.group.idGroup]=a.data}):b.user.groups.length?(b.group=b.user.groups[0],b.onChangeGrp(!0)):b.units=[])};b.toggleGlobalCollapse=function(){b.units_collapse_ini&&(b.tgs.globalCollapse?jQuery.each(b.units,
function(a,e){e.collapsed=b.units_collapse_ini[a].collapsed;e.showAll=b.units_collapse_ini[a].showAll}):jQuery.each(b.units,function(a,b){b.collapsed=!0}),b.tgs.globalCollapse=!b.tgs.globalCollapse)};b.onChangeGrp=function(a){b.group&&(l.$broadcast("changeGrp",{group:b.group}),e.setCurrentGroup(b.group),b.user.idRole===c.student&&(b.group.gopts.lang?m.use(b.group.gopts.lang):m.use(b.user.language||navigatorLang())),b.reload(a))};b.authAndGo=function(b){p.sudlg(function(){a.go(b)})};b.goAsgn=function(b,
c){e.setRelatedActivity(c);a.go("home.activity",{idActivity:b.idActivity,idAssignment:b.id})};b.$onInit=function(){b.pwcID=Math.random().toString(36);window.pw.DEBUG&&console.log("pwc-units",b.pwcID,": $onInit ");var a=jQuery(".navbar"),c=50;a&&(c=a.height()||50);b.mobile?b.headingStyle={position:"fixed","z-index":"1000",width:"100%",top:c+"px",left:"0px",height:"40px"}:b.headingStyle={};if(b.user){var f=e.getCurrentGroup();if(f&&(jQuery.each(b.user.groups,function(a,c){if(c.idGroup===f.idGroup)return b.group=
c,!0}),b.group)){b.onChangeGrp(!0);return}0<b.user.groups.length&&(b.group=b.user.groups[0],e.setCurrentGroup(b.group),b.onChangeGrp(!0))}};b.$onChanges=function(a){b.pwcID&&a.group&&b.reload(!0)}};window.pw.app.register.component("pwcUnits",{bindings:{user:"<",group:"<",collapse:"<",mobile:"@"},templateUrl:"app/components/home/pwc-units.html",controller:["$rootScope","$state","$http","$translate","$timeout","USER_ROLES","Modals","Session","growl",pwcUnitsCtrl],controllerAs:"vm"});
window.pw.app.register.controller("HomeController",["HomeService","$scope","$rootScope","$state","$http","MyCacheService","$translate","USER_ROLES","$uibModal","$window","$timeout","Auth","Session","growl","Modals","$compile",function(l,a,q,m,n,c,p,e,r,b,t,w,f,g,x,A){function u(b){var k=0,d=a.selectedGroup;d&&("B"===d.groupStudies[0]?k=2:2<d.groupLevel&&(k=1),y.httpCache("all","oftheday/all",{idUser:a.user.id,level:k,lang:p.use(),idGroup:d.idGroup},b).then(function(d){a.randomEqn=d.eqn;a.randomQuote=
d.quote;a.challenge=d.problem}))}function v(a){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(a)}l.initialize();a.user=f.getUser();if(a.user){a.amStudent=a.user.idRole===e.student;a.amStudent&&a.user.idRole===e.parents||m.go("login");a.$on("changeGrp",function(b,k){a.selectedGroup=k.group;u(!0)});l=new Date;l.setDate(l.getDate()-180);a.currentYear=l.getFullYear()-2E3;var y=c.getCache("HomeCache",
!1);a.leftClass="col-md-3 col-lg-3";a.mainClass="col-md-9 col-lg-7";a.rightClass="col-md-12 col-lg-2";a.USER_ROLES=e;c=749<$("body").width();a.tgs={mobileShow:1,welcome:!0,score:c,recent:!0,assignments:!0,famouseqn:c,quote:c,problem:c,groups:0===a.user.groups.length,users:c,chat:!0,kahootID:1};a.changeAvatar=function(){var b=a.user,k=r.open({templateUrl:"app/shared/avatar-dlg.html",controller:["$scope","Upload",function(a,z){a.title="AVATARS";a.user=b;a.limits=[0,2E3,5E3];a.avatars=[];for(var c=0;63>
c;c++)a.avatars.push({image:""+c,c:0});var f=function(b,h){jQuery.each(b,function(b,c){a.avatars[b].c=h})};f([0,1,2,11,16,21,28,29,31,30,31,32,33,34,35,51,52,53,54],0);f([3,4,5,8,9,10,12,13,14,19,20,36,37,38,39,40,41,42,43,55,56,57,58,59,60],1);f([6,7,15,17,18,22,23,24,25,27,44,45,46,47,48,49,50,61,62],2);a.custom={image:"custom/"+b.id,c:2};a.dc="";a.uploadPercent="";a.selected=null;a.score=0;b.idRole>=e.student?n.post("/rest/students/categoryscores",{idUser:b.id}).then(function(b){b=b.data;var h=
0;jQuery.each(b.badges,function(a,b){h+=b.rscore});a.score=b.score+b.vscore+b.uscore+h}):a.score=2E5;for(c in a.avatars)if(a.avatars[c].image===b.uopts.avatar){a.selected=a.avatars[c];break}a.onclick=function(b){b||(b=a.custom);a.score>=a.limits[b.c]&&(a.selected=b)};a.ok=function(){k.close(a.selected);a.dc=Math.random()};a.cancel=function(){k.dismiss()};a.upload=function(c){c&&1===c.length&&("image/png"!==c[0].type?g.warning("Image must be a png file"):z.upload({url:"/rest/fs/upload",file:c[0],fields:{idUser:b.id,
type:"avatar"}}).then(function(b){a.dc=Math.random();a.selected=a.custom},function(a){},function(b){b=parseInt(100*b.loaded/b.total);a.uploadPercent=b+"% "}))}}]});k.result.then(function(b){b&&(a.user.uopts.avatar=b.image,n.post("/rest/students/updateuopts",{uopts:a.user.uopts,id:a.user.id}),f.updateCookies())},function(){})};a.logout=function(){f.logout()};a.changeLanguage=function(a){p.use(a);q.$broadcast("changeLang",a);t(function(){u(!0)},500)};a.goAsgn=function(a,b){f.setRelatedActivity(b);m.go("home.activity",
{idActivity:a.idActivity,idAssignment:a.id})};a.go=function(a){m.go(a)};a.goAssignments=function(){m.go("home.assignments",{idGroup:0,idAssignment:0})};a.toggleMain=function(b){a.mainExpanded="undefined"===typeof b?!a.mainExpanded:b;a.mainExpanded?(a.leftClass="hidden",a.mainClass="col-md-12",a.rightClass="hidden"):(a.leftClass="col-md-3",a.mainClass="col-md-9",a.rightClass="col-lg-2")};a.toggleLeft=function(){a.leftExpanded=!a.leftExpanded;a.leftExpanded?(a.leftClass="col-md-12",a.mainClass="hidden",
a.rightClass="hidden"):(a.leftClass="col-md-3 col-lg-3",a.mainClass="col-md-9 col-lg-7",a.rightClass="col-md-2 col-lg-2")};a.toggleRight=function(){a.rightExpanded=!a.rightExpanded;a.rightExpanded?(a.leftClass="hidden",a.mainClass="hidden",a.rightClass="col-md-12"):(a.leftClass="col-md-3 col-lg-3",a.mainClass="col-md-9 col-lg-7",a.rightClass="col-md-2 col-lg-2")};a.registerSFA=function(h){h.preventDefault();if(a.amStudent){var c=h.target.href;b.open(c,"_blank");n.post("/rest/video/vscore",{idActivity:0,
idLogin:a.user.idLogin,vscore:h.target.attributes.vscore.value||1,vseconds:0,resource:c})}};a.scrollToLastChat=function(){t(function(){jQuery(".chat-scroll").each(function(){var a=jQuery(this).find(".chat-entry").last();a&&a.offset()&&(pw.bowser.mobile?window.scrollTo(0,a.offset().top):jQuery("html").animate({scrollTop:a.offset().top},1E3))})},600)};a.scrollToTop=function(){t(function(){jQuery("html").scrollTop(0)},500)};a.changePwd=function(){var b=a.user.idRole===e.parents,c=r.open({templateUrl:"app/components/home/changepwd-dlg.html",
controller:["$scope",function(d){d.oldpwd="";d.newpwd="";d.newpwd2="";d.username=(b?"Familia de ":"")+a.user.username;d.ok=function(){w.checkPassword(d.oldpwd||"").then(function(b){b.ok?6>d.newpwd.trim().length?g.error("La longitud m\u00ednima de la contrasenya s\u00f3n 6 car\u00e0cters."):d.newpwd.trim()===a.user.email.trim()?g.error("La constrasenya ha d'esser diferent que el correu electr\u00f2nic"):(b=/[0-9]/,b.test(d.newpwd)?(b=/[a-z]/,b.test(d.newpwd)?d.newpwd!==d.newpwd2?g.error("Les contrasenyes no coincideixen."):
c.close(d.newpwd):g.error("La contrasenya ha de contenir almenys una lletra min\u00fascula (a-z)!")):g.error("La constrasenya ha de contenir almenys un nombre (0-9)!")):g.warning("Contrasenya antiga inv\u00e0lida")})};d.cancel=function(){c.dismiss()}}],size:"md"});c.result.then(function(d){var c={idUser:a.user.id};b?c.passwordParents=d:c.password=d;n({method:"post",url:"/rest/auth/changepwd",data:pw.encrypt(JSON.stringify(c)),headers:{"Content-Type":"text/plain;charset=UTF-8"}}).then(function(a){a.data.ok?
x.notificationdlg("Nova contrasenya","S'ha canviat satisfact\u00f2riament la contrasenya"+(b?" d'acc\u00e9s fam\u00edlia.":".")):g.warning("Ho sentim per\u00f2, no s'ha pogut canviar la contrasenya.")})})};v(a.user.email);a.collapse=function(a){a.collapsed=!a.collapsed;a.collapsed&&(a.showAll=!1)};a.toggleGlobalCollapse=function(){};a.tabMobile=function(b){4===b?(a.scrollToLastChat(),a.tgs.chatWarning=!1):a.scrollToTop();a.tgs["tab"+b]=!0;a.tgs.mobileShow=b};f.getSocket().on("chat-recieved",function(b){b.idUser!==
a.user.id&&4!==a.tgs.mobileShow&&(a.tgs.chatWarning=!0)});a.configDlg=function(){var b=p.use()||"ca",c=r.open({templateUrl:"app/components/home/home_parents-configdlg.html",controller:["$scope",function(d){d.i18n="es"===b?{CONFIGFAMILIES:"Configuraci\u00f3n familias",EMAILS:"Emails (para m\u00e1s de uno, separadlos con comas)",FREQTEXT:"Deseo recibir un resumen del seguimiento al correo anterior con la siguiente frecuencia",PREFERREDLANG:"Idioma preferido",NEVER:"Nunca",WEEKLY:"Semanalmente",EVERY2:"Cada 2 semanas",
EVERY3:"Cada 3 semanas",MONTHLY:"Mensualmente"}:"en"===b?{CONFIGFAMILIES:"Families configuration",EMAILS:"Emails (for more than one, separate by commas)",FREQTEXT:"I would like to recieve a progress summary to the previous email with the following frequency",PREFERREDLANG:"Preferred language",NEVER:"Never",WEEKLY:"Weekly",EVERY2:"Every 2 weeks",EVERY3:"Every 3 weeks",MONTHLY:"Monthly"}:{CONFIGFAMILIES:"Configuraci\u00f3 fam\u00edlies",EMAILS:"Emails (per m\u00e9s d'un, separau-los amb comes)",FREQTEXT:"Vull rebre el resum del seguiment al correu anterior amb la seg\u00fcent freq\u00fc\u00e8ncia",
PREFERREDLANG:"Idioma preferit",NEVER:"Mai",WEEKLY:"Setmanalment",EVERY2:"Cada 2 setmanes",EVERY3:"Cada 3 setmanes",MONTHLY:"Mensualment"};d.freqOptions=[{label:d.i18n.NEVER,value:0},{label:d.i18n.WEEKLY,value:1},{label:d.i18n.EVERY2,value:2},{label:d.i18n.EVERY3,value:3},{label:d.i18n.MONTHLY,value:4}];d.langOptions=[{label:"Catal\u00e0",value:"ca"},{label:"Espa\u00f1ol",value:"es"},{label:"English",value:"en"}];d.config={email:a.user.emailParents||""};d.config.freq=d.freqOptions.filter(function(b){return b.value===
a.user.uopts.parentsMailFreq})[0]||d.freqOptions[1];d.config.lang=d.langOptions.filter(function(b){return b.value===a.user.uopts.parentsMailLang})[0]||d.langOptions[0];d.ok=function(){for(var b=d.config.email.split(","),e=0;e<b.length;e++)if(!v(b[e])){g.error(a.i18n.CHECKEMAIL);return}c.close(d.config)};d.cancel=function(){c.dismiss()}}]});c.result.then(function(b){a.user.emailParents=b.email;a.user.uopts.parentsMailFreq=b.freq.value||1;a.user.uopts.parentsMailLang=b.lang.value||"ca";f.updateStore();
n.post("/rest/students/update",{id:a.user.id,emailParents:a.user.emailParents,uopts:a.user.uopts}).then(function(b){b.data.ok?g.success(a.i18n.CONFIGUPDATED):g.error(a.i18n.CONFIGERROR)})},function(){})};q.adjustPadding()}}]);
