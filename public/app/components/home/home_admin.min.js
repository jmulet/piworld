define([],function(){window.pw.app.register.controller("HomeController",["$scope","$rootScope","$state","$http","$filter","$translate","USER_ROLES","$uibModal","$timeout","Auth","Session","growl",function(a,h,g,c,q,k,f,l,p,r,e,m){a.user=e.getUser();a.myGroups=a.user.groups;if(a.user.idRole<f.student||0===a.user.groups.length)a.user.groups=[],c.post("/rest/subjects/list").then(function(b){b.data.forEach(function(b){a.user.groups.push({id:0,groupName:b.name,idSubject:b.id,gopts:{postcomments:!0,allowenroll:!1}})});
c.post("/rest/groups/list",{idUser:a.user.id}).then(function(b){a.myGroups=b.data;jQuery.each(b.data,function(b,d){a.user.groups.unshift(d)});a.selectedGroup=a.user.groups[0];a.onChangeGrp()})});a.USER_ROLES=f;a.onChangeGrp=function(b){b&&(a.selectedGroup=b);h.$broadcast("changeGrp",{group:a.selectedGroup});e.setCurrentGroup(a.selectedGroup);a.selectedGroup.gopts.lang?k.use(a.selectedGroup.gopts.lang):k.use(a.user.language||navigatorLang());a.reload()};a.tgs={welcome:!0,score:!0,recent:!0,assignments:!0,
famouseqn:!0,quote:!0,problem:!0,groups:a.user.idRole===f.student&&0===a.myGroups.length};a.score={pos:3};a.error=!1;a.datepicker={dt:new Date,opened:!1};a.units=[];a.reload=function(){if(a.selectedGroup){var b={};a.datepicker.dt&&(b={year:a.datepicker.dt.getFullYear(),month:a.datepicker.dt.getMonth()+1});a.user.idRole>=f.student?c.post("/rest/assignments/queryasgn",{idUser:a.user.id,dt:b,idGroup:a.selectedGroup.idGroup}).then(function(b){a.units=b.data}):c.post("/rest/assignments/querycreated",{idUser:a.user.id,
dt:b,idGroup:a.selectedGroup.id}).then(function(b){a.units=b.data})}};0<a.user.groups.length&&(a.selectedGroup=a.user.groups[0],e.setCurrentGroup(a.selectedGroup),a.onChangeGrp());var n=function(){c.post("/rest/groups/listcenter",{schoolId:a.user.schoolId,idUser:a.user.id}).then(function(b){a.groupsCenter=b.data})};a.user.idRole>=f.student&&n();a.randomizeEqn=function(){c.post("/rest/oftheday/eqn").then(function(b){a.randomEqn=b.data})};a.randomizeQuote=function(){c.post("/rest/oftheday/quote").then(function(b){b=
b.data;a.randomQuote="<blockquote><p>"+b.quote+"</p><footer>"+b.author+"</footer></blockquote>"})};a.changeAvatar=function(){var b=a.user,d=l.open({templateUrl:"app/shared/avatar-dlg.html",controller:["$scope",function(a){a.title="AVATARS";a.limits=[0,500,1E3];a.avatars=[{image:"0",c:0},{image:"1",c:0},{image:"2",c:0},{image:"3",c:1},{image:"4",c:1},{image:"5",c:1},{image:"6",c:1},{image:"7",c:2}];a.selected=null;a.score=0;a.score=2E5;for(var c in a.avatars)if(a.avatars[c].image===b.uopts.avatar){a.selected=
a.avatars[c];break}a.onclick=function(b){a.score>=a.limits[b.c]&&(a.selected=b)};a.ok=function(){d.close(a.selected)};a.cancel=function(){d.dismiss()}}],size:"s"});d.result.then(function(b){b&&(a.user.uopts.avatar=b.image,c.post("/rest/students/updateuopts",{uopts:a.user.uopts,id:a.user.id}),e.updateCookies())},function(){})};a.logout=function(){e.logout()};a.changeLanguage=function(b){k.use(b);h.$broadcast("changeLang",b);p(function(){a.randomizeQuote();a.randomizeEqn()},500)};a.goAsgn=function(a){g.go("home.activity",
{idActivity:a.idActivity,idAssignment:a.id})};a.randomizeEqn();a.randomizeQuote();a.showScore=function(a,d){};a.enroll=function(b){c.post("/rest/groups/doenroll",{idUser:a.user.id,idGroup:b.id,enrollPassword:b.enrollPwd}).then(function(d){b.enrollPwd="";d=d.data;d.ok?(m.success(d.msg),a.reload(),n(),a.user.groups=a.user.groups.filter(function(a,b){return null!==a.id&&0<a.id}),a.user.groups.push(d.group||{}),a.myGroups=a.user.groups,a.selectedGroup=a.myGroups[a.myGroups.length-1],e.setCurrentGroup(a.selectedGroup),
e.updateCookies()):m.error(d.msg)})};a.removeAsgn=function(b){var d=l.open({templateUrl:"app/components/groups/create-tpl.html",controller:["$scope","$modalInstance","Auth",function(a,c,e){a.title="Confirm delete assignment "+b.id;a.msg="Segur que voleu eliminar aquesta tasca assignada?";a.invalidpwd="";a.ok=function(){e.checkPassword(a.cpwd).then(function(b){b.ok?d.close("ok"):a.invalidpwd="Invalid password"})};a.cancel=function(){c.dismiss("cancel")}}],size:"sm"});d.result.then(function(d){c.post("/rest/assignments/delete",
{idAssignment:b.id}).then(function(){a.reload()})},function(){})};a.editAsgn=function(a){g.go("home.assignments",{idGroup:a.idGroup,idAssignment:a.id})};a.goAssignments=function(){g.go("home.assignments",{idGroup:0,idAssignment:0})};a.editUnit=function(a){a.edit=!0;a.unitbck=a.unit};a.cancelEditUnit=function(a){a.unit=a.unitbck;delete a.unitbck;a.edit=!1};a.saveEditUnit=function(a){c.post("/rest/unit/save",a).then(function(){delete a.unitbck;a.edit=!1})};a.go=function(b){g.go(b);"home"===b&&a.reload()};
a.showEquations=function(){c.post("/rest/oftheday/eqns").then(function(b){a.eqns=b.data})};a.showScore(1);h.adjustPadding()}])});
