var pwcUnitsTeacherCtrl=function(f,c,d,m,p,q,k,e,n){var b=this;b.tgs={edition:!1};b.USER_ROLES=q;b.currentYear=pw.currentYear;b.tinymceOpts=f.tinymceOpts(m.use());b.noGhostFilter=function(b){return!b.gopts.isGhost};b.reportUnit=function(b){c.go("home.unittrace",{idUnit:b.id})};b.reload=function(a){if(b.pwcID){if(!b.group)if(b.user.groups.length)b.group=b.user.groups[0],b.onChangeGrp(!0);else{b.units=[];return}d.post("/rest/assignments/querycreated",{idGroup:b.group.idGroup},!0).then(function(a){b.group.thmcss&&
e.addCss(b.group.thmcss);a.data.forEach(function(a){switch(a.visible){case 0:a.collapsed=!0;break;case 1:a.collapsed=!0;a.showAll=!1;break;case 2:a.collapsed=!1;a.showAll=b.group.currentUnit===a.id;break;default:a.collapsed=!1,a.showAll=!0}a.assignments.forEach(function(a){a.fromDate&&(a.fromDate=new Date(a.fromDate));a.toDate&&(a.toDate=new Date(a.toDate))})});b.units=a.data;b.units_collapse_ini=a.data.map(function(a){return{collapsed:a.collapsed,showAll:a.showAll}});e.assignmentsCache[b.group.idGroup]=
a.data;p(function(){jQuery(".dropdown-submenu a.test").off().on("click",function(a){jQuery(this).next("ul").toggle();a.stopPropagation();a.preventDefault()})},1500)})}};b.toggleGlobalCollapse=function(){b.units_collapse_ini&&(b.tgs.globalCollapse?jQuery.each(b.units,function(a,c){c.collapsed=b.units_collapse_ini[a].collapsed;c.showAll=b.units_collapse_ini[a].showAll}):jQuery.each(b.units,function(a,b){b.collapsed=!0}),b.tgs.globalCollapse=!b.tgs.globalCollapse)};b.onChangeGrp=function(a){b.group&&
(f.$broadcast("changeGrp",{group:b.group}),e.setCurrentGroup(b.group),b.group.gopts.lang?m.use(b.group.gopts.lang):m.use(b.user.language||navigatorLang()),b.reload(a))};b.onSort=function(a,c,l,g,f){g=a.idUnit;var e;jQuery.each(b.units,function(a,b){if(b.assignments===l)return e=b.id,!0});var h=[];e!==g?(a.idUnit=e,jQuery.each(l,function(a,b){h.push({id:b.id,idUnit:b.idUnit,pos:a})})):jQuery.each(c,function(a,b){h.push({id:b.id,idUnit:b.idUnit,pos:a})});d.post("/rest/assignments/reorder",{order:h})};
b.authAndGo=function(a){k.sudlg(function(){c.go(a)})};b.goAsgn=function(a,b){e.setRelatedActivity(b);c.go("home.activity",{idActivity:a.idActivity,idAssignment:a.id})};b.getOrder=function(a){var c=0;jQuery.each(b.units,function(b,d){if(d.id===a)return c=d.assignments.length,!0});return c};b.setCurrentUnit=function(a){b.group&&(b.group.currentUnit=a.id,d.post("/rest/groups/update",b.group).then(function(a){a.data.ok||n.error("Failed to update group")}))};b.toggleVisibility=function(a,b){a.visible=
b;d.post("/rest/unit/save",a).then(function(a){a.data.ok||n.error("Failed to update unit")})};b.onToggleEdition=function(){var a=!b.tgs.edition;a?k.confirmdlgpwd("Authenticate","Voleu activar el mode edici\u00f3?",function(){b.tgs.edition=!0}):b.tgs.edition=a};b.asgnVisibility=function(a){a.visible=(a.visible+1)%2;d.post("/rest/assignments/updatevisibility",{visible:a.visible,id:a.id}).then(function(a){a.data.ok||n.error("Failed to update assignment")})};b.grades4activity=function(a){c.go("home.activitytrace",
{idActivity:a.idActivity,idAssignment:a.id,idGroup:b.group.idGroup})};b.removeAsgn=function(a){k.confirmdlgpwd("Confirm delete assignment "+a.id,"Segur que voleu eliminar aquesta tasca assignada?",function(){d.post("/rest/assignments/delete",{idAssignment:a.id}).then(function(){b.reload()},function(){n.error(":-( Unable to delete assignment.")})})};b.editAsgn=function(a){c.go("home.assignments",{idGroup:a.idGroup,idAssignment:a.id})};b.editUnit=function(a){a.edit=!0;a.unitbck=a.unit};b.cancelEditUnit=
function(a){a.unit=a.unitbck;delete a.unitbck;a.edit=!1};b.saveEditUnit=function(a){d.post("/rest/unit/save",a).then(function(){delete a.unitbck;a.edit=!1})};b.addLabelInUnit=function(a){var c={id:0,idActivity:0,open:!0,doneAttempts:0,assigned:0,instructions:"",idUnit:a.id,applyTo:null,applyToAll:1,visible:1};d.post("/rest/assignments/create",{idActivity:0,idUser:b.user.id,idUnit:a.id||0,postDate:new Date,maxAttempts:0,instructions:"<p></p>",applyTo:null,applyToAll:1,visible:1}).then(function(b){c.id=
b.data.id;a.assignments.push(c)})};b.onEditLabel=function(a){a.bck=a.instructions;a.edit=!0};b.onCancelEditLabel=function(a){a.instructions=a.bck;delete a.bck;a.edit=!1};b.onAcceptEditLabel=function(a){a.idUser=b.user.id;d.post(0<a.id?"/rest/assignments/tinyupdate":"/rest/assignments/create",a).then(function(b){delete a.bck;a.edit=!1})};b.onRemoveLabel=function(a){k.confirmdlg("Confirm delete label "+a.id,"Segur que voleu eliminar aquesta etiqueta?",function(){d.post("/rest/assignments/delete",{idAssignment:a.id}).then(function(a){b.reload()})})};
b.$onInit=function(){b.mobile?b.headingStyle={position:"fixed","z-index":"1000",width:"100%",top:"55px",left:"0px",height:"40px"}:b.headingStyle={};if(b.user){var a=e.getCurrentGroup();a&&jQuery.each(b.user.groups,function(c,d){if(d.idGroup===a.idGroup)return b.group=d,!0});0<b.user.groups.length&&(a||(b.group=b.user.groups[0],e.setCurrentGroup(b.group)),b.onChangeGrp());b.pwcID=Math.random().toString(36);window.pw.DEBUG&&console.log("pwc-units-teacher ",b.pwcID,": $onInit ");b.reload(!0)}};b.$onChanges=
function(a){window.pw.DEBUG&&console.log("pwc-units-teacher ",b.pwcID,a,": $onChanges ");b.pwcID&&a.group&&(b.$watch("changes.group.externalChanges",function(){b.reload(!0)}),b.reload(!0))}};window.pw.app.register.component("pwcUnitsTeacher",{bindings:{user:"<",group:"<",collapse:"<",mobile:"@"},templateUrl:"app/components/home/pwc-units-teacher.html",controller:["$rootScope","$state","$http","$translate","$timeout","USER_ROLES","Modals","Session","growl",pwcUnitsTeacherCtrl],controllerAs:"vm"});
window.pw.app.register.controller("HomeController",["HomeService","$scope","$rootScope","$state","$http","$translate","USER_ROLES","$uibModal","Modals","$window","$timeout","Auth","Session","growl","MyCacheService","$ocLazyLoad",function(f,c,d,m,p,q,k,e,n,b,a,u,l,g,v,w){c.USER_ROLES=k;f.initialize();var h;w.load("ngIdle").then(["Idle","IdleProvider",function(a,b){b.idle(window.pw.isMobile()?86400:600);b.timeout(30);a.watch();d.$on("IdleStart",function(){h=e.open({templateUrl:"app/shared/alert-dlg.html",
controller:["$scope",function(a){a.count=30;a.ok=function(){h.close(!0)};a.title="Temps d'inactivitat";a.msg="Es tancar\u00e0 la sessi\u00f3 en {{count}} segons."}]});h.result.then(function(b){b&&a.watch()},function(){a.watch()})});d.$on("IdleTimeout",function(){h&&h.close();l.logout()});d.$on("IdleEnd",function(){h.close(!0)})}]);c.user=l.getUser();c.$on("changeGrp",function(a,b){c.selectedGroup=b.group;t(!0)});c.user&&c.user.idRole!==k.guest||m.go("login");var x=v.getCache("HomeCache",!1),t=function(a){var b=
0,r=c.selectedGroup;r&&("B"===r.groupStudies[0]?b=2:2<r.groupLevel&&(b=1),x.httpCache("all","oftheday/all",{idUser:c.user.id,level:b,lang:q.use(),idGroup:r.idGroup},a).then(function(a){c.randomEqn=a.eqn;c.randomQuote=a.quote;c.challenge=a.problem}))};c.leftClass="col-md-3 col-lg-3";c.mainClass="col-md-9 col-lg-7";c.rightClass="col-md-12 col-lg-2";c.dc="";f=749<jQuery("body").width();c.tgs={mobileShow:1,welcome:f,score:f,recent:!0,assignments:!0,famouseqn:f,quote:f,problem:f,groups:0===c.user.groups.length,
users:f,chat:!0};c.error=!1;c.authAndGo=function(a){n.sudlg(function(){m.go(a)})};c.scrollToLastChat=function(){a(function(){jQuery(".chat-scroll").each(function(){var a=jQuery(this).find(".chat-entry").last();a&&a.offset()&&(pw.bowser.mobile?window.scrollTo(0,a.offset().top):jQuery("html").animate({scrollTop:a.offset().top},1E3))})},600)};c.scrollToTop=function(){a(function(){jQuery("#mainview,html,body").scrollTop(0)},500)};c.changeAvatar=function(){var a=c.user,b=e.open({templateUrl:"app/shared/avatar-dlg.html",
controller:["$scope","Upload",function(c,d){c.title="AVATARS";c.user=a;c.limits=[0,2E3,5E3];c.avatars=[];for(var e=0;63>e;e++)c.avatars.push({image:""+e,c:0});var f=function(a,b){a.forEach(function(a){c.avatars[a].c=b})};f([0,1,2,11,16,21,28,29,31,30,31,32,33,34,35,51,52,53,54],0);f([3,4,5,8,9,10,12,13,14,19,20,36,37,38,39,40,41,42,43,55,56,57,58,59,60],1);f([6,7,15,17,18,22,23,24,25,27,44,45,46,47,48,49,50,61,62],2);c.custom={image:"custom/"+a.id,c:2};c.dc="";c.uploadPercent="";c.selected=null;c.score=
0;c.score=2E5;for(e in c.avatars)if(c.avatars[e].image===a.uopts.avatar){c.selected=c.avatars[e];break}c.onclick=function(a){a||(a=c.custom);c.score>=c.limits[a.c]&&(c.selected=a)};c.ok=function(){b.close(c.selected);c.dc=Math.random()};c.cancel=function(){b.dismiss()};c.upload=function(b){b&&1===b.length&&("image/png"!==b[0].type?g.warning("Image must be a png file"):d.upload({url:"/rest/fs/upload",file:b[0],fields:{idUser:a.id,type:"avatar"}}).then(function(a){c.dc=Math.random();c.selected=c.custom},
function(a){},function(a){a=parseInt(100*a.loaded/a.total);c.uploadPercent=a+"% "}))}}]});b.result.then(function(a){a&&(c.user.uopts.avatar=a.image,p.post("/rest/students/updateuopts",{uopts:c.user.uopts,id:c.user.id}),l.updateCookies())},function(){})};c.logout=function(){l.logout()};c.changeLanguage=function(b){q.use(b);d.$broadcast("changeLang",b);a(function(){t(!0)},500)};c.go=function(a){m.go(a)};c.toggleMain=function(){c.mainExpanded=!c.mainExpanded;c.mainExpanded?(c.leftClass="hidden",c.mainClass=
"col-md-12",c.rightClass="hidden"):(c.leftClass="col-md-3 col-lg-3",c.mainClass="col-md-9 col-lg-7",c.rightClass="col-lg-2")};c.toggleLeft=function(){c.leftExpanded=!c.leftExpanded;c.leftExpanded?(c.leftClass="col-md-12",c.mainClass="hidden",c.rightClass="hidden"):(c.leftClass="col-md-3 col-lg-3",c.mainClass="col-md-9 col-lg-7",c.rightClass="col-md-2 col-lg-2")};c.toggleRight=function(){c.rightExpanded=!c.rightExpanded;c.rightExpanded?(c.leftClass="hidden",c.mainClass="hidden",c.rightClass="col-md-12"):
(c.leftClass="col-md-3 col-lg-3",c.mainClass="col-md-9 col-lg-7",c.rightClass="col-md-2 col-lg-2")};c.registerSFA=function(a){a.preventDefault();var d=a.target.href;b.open(d,"_blank");c.user.idRole===k.student&&p.post("/rest/video/vscore",{idActivity:0,idLogin:c.user.idLogin,vscore:a.target.attributes.vscore.value||1,vseconds:0,resource:d})};c.changePwd=function(){var a=c.user.idRole===k.parents,b=e.open({templateUrl:"app/components/home/changepwd-dlg.html",controller:["$scope",function(d){d.oldpwd=
"";d.newpwd="";d.newpwd2="";d.username=(a?"Familia de ":"")+c.user.username;d.ok=function(){u.checkPassword(d.oldpwd||"").then(function(a){a.ok?6>d.newpwd.trim().length?g.error("La longitud m\u00ednima de la contrasenya s\u00f3n 6 car\u00e0cters."):d.newpwd.trim()===c.user.email.trim()?g.error("La constrasenya ha d'esser diferent que el correu electr\u00f2nic"):(a=/[0-9]/,a.test(d.newpwd)?(a=/[a-z]/,a.test(d.newpwd)?d.newpwd!==d.newpwd2?g.error("Les contrasenyes no coincideixen."):b.close(d.newpwd):
g.error("La contrasenya ha de contenir almenys una lletra min\u00fascula (a-z)!")):g.error("La constrasenya ha de contenir almenys un nombre (0-9)!")):g.warning("Contrasenya antiga inv\u00e0lida")})};d.cancel=function(){b.dismiss()}}],size:"md"});b.result.then(function(b){var d={idUser:c.user.id};a?d.passwordParents=b:d.password=b;p({method:"post",url:"/rest/auth/changepwd",data:pw.encrypt(JSON.stringify(d)),headers:{"Content-Type":"text/plain;charset=UTF-8"}}).then(function(b){b.data.ok?n.notificationdlg("Nova contrasenya",
"S'ha canviat satisfact\u00f2riament la contrasenya"+(a?" d'acc\u00e9s fam\u00edlia.":".")):g.warning("Ho sentim per\u00f2, no s'ha pogut canviar la contrasenya.")})})};c.tabMobile=function(a){4===a&&(c.scrollToLastChat(),c.tgs.chatWarning=!1);c.tgs["tab"+a]=!0;c.tgs.mobileShow=a;c.scrollToTop()};l.getSocket().on("chat-recieved",function(a){a.idUser!==c.user.id&&4!==c.tgs.mobileShow&&(c.tgs.chatWarning=!0)});d.adjustPadding()}]);
