window.pw.app.register.service("videoEmbedUtils",["$http","$q",function(k,g){return{videoInfo:function(e){var f=g.defer();k.post("/rest/video/vinfo",e).then(function(e){f.resolve(e.data)});return f.promise},updateVisualization:function(e){var f=g.defer();k.post("/rest/video/vscore",e).then(function(e){f.resolve(e.data)});return f.promise},registerVisualizationQuizz:function(e){var f=g.defer();k.post("/rest/video/vquizz",e).then(function(e){f.resolve(e.data)});return f.promise},setRating:function(e,
f,g){k.post("/rest/activity/updaterating",{idActivity:e,idUser:f,vrating:g})}}}]);
window.pw.app.register.directive("videoEmbed",["videoEmbedUtils","$compile","Session","USER_ROLES","$templateCache","$timeout","Modals","$window",function(k,g,e,f,E,l,M,N){function O(a,e){var f,k,g=e;this.pause=function(){window.clearTimeout(f);g-=new Date-k;f=null};this.paused=function(){return null===f};var l=function(){k=new Date;f=window.setTimeout(function(){g=e;l();a()},g)};this.resume=l;this.resume()}function z(a){if("string"===typeof a){var e=a.split(":").reverse();try{var f=0,g=1;e.forEach(function(a){f+=
parseInt(a)*g;g*=60});a=f}catch(k){}}return a}return{restrict:"EA",scope:{videoId:"=?",videoUrl:"=?",player:"=?",playerVars:"=?",playerHeight:"=?",playerWidth:"=?",questions:"=?",notes:"=?",crop:"=?",activity:"<",offset:"=?",poster:"=?"},replace:!0,templateUrl:"assets/js/video.js/pw-video.html",link:function(a,K,F){function G(){a.markers=[];a.hasQuestions&&jQuery.each(a.questions,function(b,c){a.markers.push({time:c.time,text:"Pregunta "+(b+1)})});a.notes&&jQuery.each(a.notes,function(b,c){a.markers.push({time:c.time,
overlayText:c.text,markerStyle:{width:"2px","background-color":"Orange"}})})}function P(h){y("youtube.player.playing",b,h);(h=jQuery(b.el()).find(".vjs-poster"))&&h.addClass("vjs-hidden");a.state.played=!0;a.pg.isPlaying=!0;n?n.paused()&&n.resume():n=new O(function(){if(!b.paused()){var c=0;100>a.activity.vscorenow+a.activity.vscore&&(a.activity.vscorenow+=H,c=H);v+=p;!A&&0<v&&a.idActivity&&!a.isSessionDead&&(B+=c,I+=p,k.updateVisualization({id:m,idActivity:a.idActivity,idAssignment:a.idAssignment,
resource:F.videoUrl||w,idLogin:J,vscore:c,vseconds:p}).then(function(a){!m&&a.ok&&(m=a.id)}))}},1E3*p);a.state.showQuestions&&b.pause()}function y(){var b=Array.prototype.slice.call(arguments);l(function(){a.$emit.apply(a,b)})}function Q(h){b&&(!A&&a.idActivity&&k.videoInfo({idActivity:a.idActivity,idAssignment:a.idAssignment,resource:F.videoUrl||w,idUser:t.id}).then(function(b){a.idAssignment||(p+=30);b.closed&&(p+=15);a.activity.vscore=b.vscore||0;v=b.seconds||0;b.idLogins===J&&(m=b.id)}),y("youtube.player.ready",
b,h))}function R(a){y("youtube.player.error",b,a)}function S(b){n&&n.pause();a.pg.isPlaying=!1}function T(h){h=b.currentTime();var c=null;if(a.questions)for(var d=0;d<a.questions.length;d++)if(C<=a.questions[d].time&&a.questions[d].time<=h){c=a.questions[d];break}!c||b.paused()||a.state.showQuestions||(b.pause(),b.userActive(!1),b.controlBar.hide(),n&&n.pause(),l(function(){a.pg.isPlaying=!1;c.title=c.title||"Q\u00fcesti\u00f3";a.playerVars.preview&&(c.input="",c.check=0,c.options&&jQuery.each(c.options,
function(a,b){b.check=0;b.selected=!1}));a.question=c;a.state.showQuestions=!0;r.removeClass("vjs-hidden");a.state.qclass="col-xs-12 col-md-4";a.state.mclass="col-xs-12 col-md-8 grayscale"}),a.isSessionDead||(a.deadManListener=l(function(){console.log("Visualization time is dead");a.isSessionDead=!0;k.updateVisualization({id:m,idActivity:a.idActivity,idAssignment:a.idAssignment,resource:F.videoUrl||w,idLogin:J,vscore:-B,vseconds:-I}).then(function(a){!m&&a.ok&&(m=a.id)});a.activity.vscorenow-=B;a.closeQuestions();
b.currentTime(0);b.pause();a.questions=[{time:Math.floor(480*Math.random())+120,check:0,formulation:"Segueixes l'explicaci\u00f3?",type:"multiple",options:[]}]},L)),a.soundEnabled&&0===c.check&&(d=Math.round(2*Math.random())+1,q="theme"+d,pw.Sound.play("theme"+d,2,.3)));C=h}function U(){var h=jQuery("#"+a.playerId);if(h[0]){h.empty();var c='<video id="'+a.playerId+'video" class="video-js vjs-big-play-centered vjs-default-skin embed-responsive-item" controls preload="auto">\n<p class="vjs-no-js">\n     To view this video please enable JavaScript, and consider upgrading to a web browser that \n     <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>\n</p>\n</video>',
c=jQuery(c);h.append(c);var d={techOrder:[],sources:[]};a.poster&&(d.poster=a.poster);0<=a.videoUrl.toLowerCase().indexOf(".mp4")?(d.techOrder.push("html5"),d.sources.push({type:"video/mp4",src:a.videoUrl}),a.idActivity&&(d.poster="activities/"+a.idActivity+"/icon_large.jpg")):0<=a.videoUrl.toLowerCase().indexOf("vimeo")?(d.techOrder.push("vimeo"),d.sources.push({type:"video/vimeo",src:a.videoUrl+"?bust="+(new Date).getTime()}),d.vimeo={iv_load_policy:1,ytControls:0},d.poster="activities/"+a.idActivity+
"/icon_large.jpg"):(d.techOrder.push("youtube"),a.videoUrl=a.videoUrl.replace(/http:/gi,"https:"),d.sources.push({type:"video/youtube",src:a.videoUrl+"?bust="+(new Date).getTime()}),d.youtube={ytControls:0,cc_load_policy:1,modestbranding:1,forceSSL:!0,autoplay:0,rel:0,playsinline:1,enablejsapi:1,origin:"https://pw.es"});a.offset&&(d.offset=a.offset);b=videojs(c[0],d);b.piWorld=b.piWorld||{};b.markers({markerStyle:{width:"4px","background-color":"Lime"},markers:a.markers,breakOverlay:{display:!0,displayTime:4}});
x=jQuery(b.el());"youtube"===d.techOrder[0]&&x.find(".vjs-control-bar").before("<div class='transparent'></div>");a.questions&&(c=E.get("/assets/libs/video.js/pw-questions.html"),r=jQuery("<div class='vjs-questions vjs-hidden'></div>"),r.append(c),g(r.contents())(a),x.append(r));!A&&0<a.idActivity&&!a.playerVars.preview&&(c=E.get("/assets/libs/video.js/pw-picoin.html"),c=jQuery(c),g(c.contents())(a),x.append(c));a.questions&&b.userActive(!1);b.ready(function(){y("youtube.player.unstarted",this);if(pw.isMobile()&&
pw.bowser.Safari){var c=h.find("button.vjs-fullscreen-control.vjs-control.vjs-button");c.unbind().off();c.on("click",function(a){window.pw.FScreen.toggleFullscreen(h,c)});window.pw.FScreen.setOnfullscreenchange(function(a){window.pw.FScreen.fullscreenElement()||window.pw.FScreen.exitFullscreen()})}this.on("loadedmetadata",Q);this.on("playing",P);this.on("error",R);this.on("pause",S);this.on("timeupdate",T);this.on("durationchange",function(){a.duration=b.duration();a.duration&&v>2*a.duration&&(console.log("Maximum visualization time detected for video "+
a.idActivity+". No further points will be added."),H=0)});this.on("ended",function(){if(0<a.idActivity&&!a.playerVars.preview&&!a.videoRating)if(u)u.removeClass("vjs-hidden");else{var b=E.get("/assets/libs/video.js/pw-endposter.html");u=jQuery(b);g(u.contents())(a);x.append(u)}})});b.id=w;return b}}e.addCss("/assets/js/video.js/5.14/video-js.min.css");e.addCss("/assets/js/video.js/5.14/videojs-markers.min.css");K.css({"max-width":"80%",margin:"auto"});var w=Math.random().toString(36).slice(2);a.playerId=
w;a.isMobile=window.pw.isMobile();a.videoUrl=a.videoUrl||"https://www.youtube.com/watch?v="+a.videoId;var p=10,H=1,L=15E4,v=1,C=0,B=0,I=0,t=e.getUser(),D=t.idRole===f.parents,A=t.idRole===f.guest||D,J=t.idLogin,m=0,b,x,r,u,n;a.soundSupported=!1;if(a.questions&&a.soundSupported){pw.Sound.register({theme1:"/assets/sounds/theme.ogg",theme2:"/assets/sounds/answer_20sec.ogg",theme3:"/assets/sounds/answer_30sec.ogg",ok:"/assets/sounds/0236.ogg",wrong:"/assets/sounds/0899.ogg"});a.soundEnabled=!1;var q=
null;a.toggleSound=function(){a.soundEnabled=!a.soundEnabled;t.uopts.vqsound=a.soundEnabled?1:0;e.updateUopts();if(a.soundEnabled){var b=Math.round(2*Math.random())+1;q="theme"+b;pw.Sound.play("theme"+b,2,.3)}else pw.Sound.stop()}}D=a.activity||{};a.idActivity=D.id||0;a.idAssignment=D.idAssignment||0;if("string"===typeof a.questions)try{a.questions=JSON.parse(a.questions)}catch(h){}a.questions&&a.questions.length?(a.hasQuestions=!0,jQuery.each(a.questions,function(a,b){b.time=z(b.time);b.check=0})):
(L=3E4,a.hasQuestions=!1,a.questions=[{time:Math.floor(580*Math.random())+120,check:0,formulation:"Segueixes l'explicaci\u00f3?",type:"multiple",options:[]}]);a.notes&&jQuery.each(a.notes,function(a,b){b.time=z(b.time)});G();a.pg={isPlaying:!1,tgsQuestion:!0,total:"00:00",ellapsed:"00:00",remaining:"00:00",max:100,value:0};a.priv=!1;a.activity={vscore:0,vscorenow:0};a.state={fs:!1,cclass:"row",showQuestions:!1,qclass:"col-xs-12 col-md-4",mclass:"col-md-12",played:!1};a.play_pause=function(){b&&(a.pg.isPlaying?
b.pause():(a.deadManListener&&l.cancel(a.deadManListener),b.play()),a.pg.isPlaying=!a.pg.isPlaying)};a.toggleOpt=function(b){0===a.question.check&&(b.selected=!b.selected)};a.toggleQuestion=function(){a.pg.tgsQuestion=!a.pg.tgsQuestion;r.find(".vjs-questions-container").css("height",a.pg.tgsQuestion?"90%":"40px")};a.closeQuestions=function(){a.deadManListener&&l.cancel(a.deadManListener);r.addClass("vjs-hidden");b.controlBar.show();a.state.showQuestions=!1;a.state.qclass="col-xs-12 col-md-4";a.state.mclass=
"col-md-12";C+=1;b.currentTime(b.currentTime()+.5);b.play();q&&(pw.Sound.stop(q),q="")};a.doCheck=function(){if(a.question.check)a.closeQuestions();else{var b=5;"input"===a.question.type?a.question.check=a.question.input==a.question.answer?1:-1:"multiple"===a.question.type&&(a.question.input="",a.question.answer="",a.question.check=1,jQuery.each(a.question.options,function(b,d){d.selected&&(a.question.input+=d.title+"; ");d.valid&&(a.question.answer+=d.title+"; ");d.valid&&d.selected?d.check=1:d.valid||
d.selected?(d.check=-1,a.question.check=-1):d.check=0}),b=Math.floor(5));a.soundEnabled&&q&&(pw.Sound.stop(q),q="");!A&&0<m&&a.hasQuestions&&(a.activity.vscorenow+=a.question.check*b,k.registerVisualizationQuizz({idV:m,formulation:a.question.formulation,answer:a.question.input,rightAnswer:a.question.answer,isValid:0<a.question.check,penalty:b}));a.deadManListener&&l.cancel(a.deadManListener)}};a.playerHeight=a.playerHeight||390;a.playerWidth=a.playerWidth||640;a.playerVars=a.playerVars||{};a.onRateVideo=
function(){k.setRating(a.idActivity,t.id,a.videoRating);u.addClass("vjs-hidden")};var V=a.$watchCollection("questions",function(e,c){b&&(jQuery.each(a.questions,function(a,b){b.time=z(b.time)}),G(),b.markers.reset(a.markers))}),W=a.$watchCollection("notes",function(e,c){b&&(jQuery.each(a.notes,function(a,b){b.time=z(b.time)}),G(),b.markers.reset(a.markers))});a.$watchCollection(["playerHeight","playerWidth"],function(){b&&a.playerWidth&&a.playerHeight&&b.setSize(a.playerWidth,a.playerHeight)});l(function(){if(a.videoId||
a.playerVars.list)b&&"function"===typeof b.dispose&&b.dispose(),require(["videojs"],function(a){window.videojs=window.videojs||a;b=U()})});a.gotoSource=function(){M.confirmdlg("Enlla\u00e7 extern","<p><b>ATENCI\u00d3!</b> Estau apunt de sortir de pw. No es comptaran punts de visualitzaci\u00f3.</p><p><b>SUGGERIMENT: </b>Deixau un comentari al canal youtube perqu\u00e8 el professor pugui saber que heu accedit al v\u00eddeo.</p><p>Voleu anar a youtube?</p>",function(){N.open(a.videoUrl,"_blank")})};
a.$on("$destroy",function(){V();W();a.deadManListener&&l.cancel(a.deadManListener);var e=K.find("iframe");e[0]&&(e[0].src="about:blank");b&&(b.dispose(),jQuery("#"+a.playerId).empty());pw.Sound.stop();$("button.vjs-fullscreen-control.vjs-control.vjs-button").off();window.pw.FScreen.setOnfullscreenchange(null)})}}}]);
