window.pw.app.register.service("videoEmbedUtils",["$http","$q",function(e,i){var t={};return t.videoInfo=function(t){var s=i.defer();return e.post("/rest/video/vinfo",t).then(function(e){s.resolve(e.data)}),s.promise},t.updateVisualization=function(t){var s=i.defer();return e.post("/rest/video/vscore",t).then(function(e){s.resolve(e.data)}),s.promise},t.registerVisualizationQuizz=function(t){var s=i.defer();return e.post("/rest/video/vquizz",t).then(function(e){s.resolve(e.data)}),s.promise},t.setRating=function(i,t,s){e.post("/rest/activity/updaterating",{idActivity:i,idUser:t,vrating:s})},t}]),window.pw.app.register.directive("videoEmbed",["videoEmbedUtils","$compile","Session","USER_ROLES","$templateCache","$timeout","Modals","$window",function(e,i,t,s,o,n,a,r){function d(e,i){var t,s,o=i;this.pause=function(){window.clearTimeout(t),o-=new Date-s,t=null},this.paused=function(){return null===t};var n=function(){s=new Date,t=window.setTimeout(function(){o=i,n(),e()},o)};this.resume=n,this.resume()}function u(e){if("string"==typeof e){var i=e.split(":").reverse();try{var t=0,s=1;i.forEach(function(e){t+=parseInt(e)*s,s*=60}),e=t}catch(e){}}return e}function c(e,i){return Math.floor((i-e)*Math.random())+e}var l="youtube.player.";return{restrict:"EA",scope:{videoId:"=?",videoUrl:"=?",player:"=?",playerVars:"=?",playerHeight:"=?",playerWidth:"=?",questions:"=?",notes:"=?",crop:"=?",activity:"<",offset:"=?",poster:"=?"},replace:!0,templateUrl:"assets/js/video.js/pw-video.html",link:function(p,v,h){function f(){p.markers=[],p.hasQuestions&&jQuery.each(p.questions,function(e,i){p.markers.push({time:i.time,text:"Pregunta "+(e+1)})}),p.notes&&jQuery.each(p.notes,function(e,i){p.markers.push({time:i.time,overlayText:i.text,markerStyle:{width:"2px","background-color":"Orange"}})})}function y(i){m(l+"playing",A,i);var t=jQuery(A.el()),s=t.find(".vjs-poster");s&&s.addClass("vjs-hidden"),p.state.played=!0,p.pg.isPlaying=!0,x?x.paused()&&x.resume():x=new d(function(){if(!A.paused()){var i=0;if(p.activity.vscorenow+p.activity.vscore<V&&(p.activity.vscorenow+=L,i=L),O+=E,!P&&O>0&&p.idActivity&&!p.isSessionDead){I+=i,_+=E;var t={id:F,idActivity:p.idActivity,idAssignment:p.idAssignment,resource:h.videoUrl||Q,idLogin:W,vscore:i,vseconds:E};e.updateVisualization(t).then(function(e){!F&&e.ok&&(F=e.id)})}}},1e3*E),p.state.showQuestions&&A.pause()}function m(){var e=Array.prototype.slice.call(arguments);n(function(){p.$emit.apply(p,e)})}function g(i){A&&(!P&&p.idActivity&&e.videoInfo({idActivity:p.idActivity,idAssignment:p.idAssignment,resource:h.videoUrl||Q,idUser:R.id}).then(function(e){p.idAssignment||(E+=30),e.closed&&(E+=15),p.activity.vscore=e.vscore||0,O=e.seconds||0,e.idLogins===W&&(F=e.id)}),m(l+"ready",A,i))}function w(e){m(l+"error",A,e)}function b(e){x&&x.pause(),p.pg.isPlaying=!1}function j(i){var t=A.currentTime(),s=null;if(p.questions)for(var o=0;o<p.questions.length;o++)if(T<=p.questions[o].time&&p.questions[o].time<=t){s=p.questions[o];break}if(s&&!A.paused()&&!p.state.showQuestions&&(A.pause(),A.userActive(!1),A.controlBar.hide(),x&&x.pause(),n(function(){p.pg.isPlaying=!1,s.title=s.title||"Qüestió",p.playerVars.preview&&(s.input="",s.check=0,s.options&&jQuery.each(s.options,function(e,i){i.check=0,i.selected=!1})),p.question=s,p.state.showQuestions=!0,M.removeClass("vjs-hidden"),p.state.qclass="col-xs-12 col-md-4",p.state.mclass="col-xs-12 col-md-8 grayscale"}),p.isSessionDead||(p.deadManListener=n(function(){console.log("Visualization time is dead"),p.isSessionDead=!0;var i={id:F,idActivity:p.idActivity,idAssignment:p.idAssignment,resource:h.videoUrl||Q,idLogin:W,vscore:-I,vseconds:-_};e.updateVisualization(i).then(function(e){!F&&e.ok&&(F=e.id)}),p.activity.vscorenow-=I,p.closeQuestions(),A.currentTime(0),A.pause(),p.questions=[{time:c(120,600),check:0,formulation:"Segueixes l'explicació?",type:"multiple",options:[]}]},z)),p.soundEnabled&&0===s.check)){var a=Math.round(2*Math.random())+1;N="theme"+a,pw.Sound.play("theme"+a,2,.3)}T=t}function q(){var e=jQuery("#"+p.playerId);if(e[0]){e.empty();var t='<video id="'+p.playerId+'video" class="video-js vjs-big-play-centered vjs-default-skin embed-responsive-item" controls preload="auto">\n<p class="vjs-no-js">\n     To view this video please enable JavaScript, and consider upgrading to a web browser that \n     <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>\n</p>\n</video>',s=jQuery(t);e.append(s);var n={techOrder:[],sources:[]};if(p.poster&&(n.poster=p.poster),p.videoUrl.toLowerCase().indexOf(".mp4")>=0?(n.techOrder.push("html5"),n.sources.push({type:"video/mp4",src:p.videoUrl}),p.idActivity&&(n.poster="activities/"+p.idActivity+"/icon_large.jpg")):p.videoUrl.toLowerCase().indexOf("vimeo")>=0?(n.techOrder.push("vimeo"),n.sources.push({type:"video/vimeo",src:p.videoUrl+"?bust="+(new Date).getTime()}),n.vimeo={iv_load_policy:1,ytControls:0},n.poster="activities/"+p.idActivity+"/icon_large.jpg"):(n.techOrder.push("youtube"),p.videoUrl=p.videoUrl.replace(/http:/gi,"https:"),n.sources.push({type:"video/youtube",src:p.videoUrl+"?bust="+(new Date).getTime()}),n.youtube={ytControls:0,cc_load_policy:1,modestbranding:1,forceSSL:!0,autoplay:0,rel:0,playsinline:1,enablejsapi:1,origin:"https://pw.es"}),p.offset&&(n.offset=p.offset),A=videojs(s[0],n),A.piWorld=A.piWorld||{},A.markers({markerStyle:{width:"4px","background-color":"Lime"},markers:p.markers,breakOverlay:{display:!0,displayTime:4}}),S=jQuery(A.el()),"youtube"===n.techOrder[0]&&S.find(".vjs-control-bar").before("<div class='transparent'></div>"),p.questions){var t=o.get("/assets/libs/video.js/pw-questions.html");M=jQuery("<div class='vjs-questions vjs-hidden'></div>"),M.append(t),i(M.contents())(p),S.append(M)}if(!P&&p.idActivity>0&&!p.playerVars.preview){var t=o.get("/assets/libs/video.js/pw-picoin.html"),a=jQuery(t);i(a.contents())(p),S.append(a)}else console.log("Not showing picoin because:: "),console.log("isGuest: ",P),console.log("idActivity: ",p.idActivity),console.log("playerVars.preview: ",p.playerVars.preview);return p.questions&&A.userActive(!1),A.ready(function(){if(m(l+"unstarted",this),pw.isMobile()&&pw.bowser.Safari){var t=e.find("button.vjs-fullscreen-control.vjs-control.vjs-button");t.unbind().off(),t.on("click",function(i){window.pw.FScreen.toggleFullscreen(e,t)}),window.pw.FScreen.setOnfullscreenchange(function(e){window.pw.FScreen.fullscreenElement()||window.pw.FScreen.exitFullscreen()})}this.on("loadedmetadata",g),this.on("playing",y),this.on("error",w),this.on("pause",b),this.on("timeupdate",j),this.on("durationchange",function(){p.duration=A.duration(),p.duration&&O>2*p.duration&&(console.log("Maximum visualization time detected for video "+p.idActivity+". No further points will be added."),L=0)}),this.on("ended",function(){if(p.idActivity>0&&!p.playerVars.preview&&!p.videoRating)if(U)U.removeClass("vjs-hidden");else{var e=o.get("/assets/libs/video.js/pw-endposter.html");U=jQuery(e),i(U.contents())(p),S.append(U)}})}),A.id=Q,A}}function k(){(p.videoId||p.playerVars.list)&&(A&&"function"==typeof A.dispose&&A.dispose(),require(["videojs"],function(e){window.videojs=window.videojs||e,A=q()}))}t.addCss("/assets/js/video.js/5.14/video-js.min.css"),t.addCss("/assets/js/video.js/5.14/videojs-markers.min.css"),v.css({"max-width":"80%",margin:"auto"});var Q=Math.random().toString(36).slice(2);p.playerId=Q,p.isMobile=window.pw.isMobile(),p.videoUrl=p.videoUrl||"https://www.youtube.com/watch?v="+p.videoId;var A,S,M,U,x,E=10,L=1,V=100,C=5,z=15e4,O=1,T=0,I=0,_=0,R=t.getUser(),D=R.idRole===s.parents,P=R.idRole===s.guest||D,W=(R.idRole===s.student,R.idLogin),F=0;if(p.soundSupported=!1,p.questions&&p.soundSupported){var H={theme1:"/assets/sounds/theme.ogg",theme2:"/assets/sounds/answer_20sec.ogg",theme3:"/assets/sounds/answer_30sec.ogg",ok:"/assets/sounds/0236.ogg",wrong:"/assets/sounds/0899.ogg"};pw.Sound.register(H),p.soundEnabled=!1;var N=null;p.toggleSound=function(){if(p.soundEnabled=!p.soundEnabled,R.uopts.vqsound=p.soundEnabled?1:0,t.updateUopts(),p.soundEnabled){var e=Math.round(2*Math.random())+1;N="theme"+e,pw.Sound.play("theme"+e,2,.3)}else pw.Sound.stop()}}var G=p.activity||{};if(p.idActivity=G.id||0,p.idAssignment=G.idAssignment||0,"string"==typeof p.questions)try{p.questions=JSON.parse(p.questions)}catch(e){}p.questions&&p.questions.length?(p.hasQuestions=!0,jQuery.each(p.questions,function(e,i){i.time=u(i.time),i.check=0})):(z=3e4,p.hasQuestions=!1,p.questions=[{time:c(120,700),check:0,formulation:"Segueixes l'explicació?",type:"multiple",options:[]}]),p.notes&&jQuery.each(p.notes,function(e,i){i.time=u(i.time)}),f(),p.pg={isPlaying:!1,tgsQuestion:!0,total:"00:00",ellapsed:"00:00",remaining:"00:00",max:100,value:0},p.priv=!1,p.activity={vscore:0,vscorenow:0},p.state={fs:!1,cclass:"row",showQuestions:!1,qclass:"col-xs-12 col-md-4",mclass:"col-md-12",played:!1},p.play_pause=function(){A&&(p.pg.isPlaying?A.pause():(p.deadManListener&&n.cancel(p.deadManListener),A.play()),p.pg.isPlaying=!p.pg.isPlaying)},p.toggleOpt=function(e){0===p.question.check&&(e.selected=!e.selected)},p.toggleQuestion=function(){p.pg.tgsQuestion=!p.pg.tgsQuestion,M.find(".vjs-questions-container").css("height",p.pg.tgsQuestion?"90%":"40px")},p.closeQuestions=function(){p.deadManListener&&n.cancel(p.deadManListener),M.addClass("vjs-hidden"),A.controlBar.show(),p.state.showQuestions=!1,p.state.qclass="col-xs-12 col-md-4",p.state.mclass="col-md-12",T+=1,A.currentTime(A.currentTime()+.5),A.play(),N&&(pw.Sound.stop(N),N="")},p.doCheck=function(){if(p.question.check)return void p.closeQuestions();var i=C;if("input"===p.question.type)p.question.input==p.question.answer?p.question.check=1:p.question.check=-1;else if("multiple"===p.question.type){p.question.input="",p.question.answer="",p.question.check=1;var t=1;jQuery.each(p.question.options,function(e,i){i.selected&&(p.question.input+=i.title+"; "),i.valid&&(p.question.answer+=i.title+"; "),i.valid&&i.selected?i.check=1:i.valid||i.selected?(i.check=-1,p.question.check=-1):i.check=0}),i=Math.floor(t*C)}p.soundEnabled&&N&&(pw.Sound.stop(N),N=""),!P&&F>0&&p.hasQuestions&&(p.activity.vscorenow=p.activity.vscorenow+p.question.check*i,e.registerVisualizationQuizz({idV:F,formulation:p.question.formulation,answer:p.question.input,rightAnswer:p.question.answer,isValid:p.question.check>0,penalty:i})),p.deadManListener&&n.cancel(p.deadManListener)},p.playerHeight=p.playerHeight||390,p.playerWidth=p.playerWidth||640,p.playerVars=p.playerVars||{},p.onRateVideo=function(){e.setRating(p.idActivity,R.id,p.videoRating),U.addClass("vjs-hidden")};var B=p.$watchCollection("questions",function(e,i){A&&(jQuery.each(p.questions,function(e,i){i.time=u(i.time)}),f(),A.markers.reset(p.markers))}),J=p.$watchCollection("notes",function(e,i){A&&(jQuery.each(p.notes,function(e,i){i.time=u(i.time)}),f(),A.markers.reset(p.markers))});p.$watchCollection(["playerHeight","playerWidth"],function(){A&&p.playerWidth&&p.playerHeight&&A.setSize(p.playerWidth,p.playerHeight)}),n(k),p.gotoSource=function(){var e=function(){r.open(p.videoUrl,"_blank")};a.confirmdlg("Enllaç extern","<p><b>ATENCIÓ!</b> Estau apunt de sortir de pw. No es comptaran punts de visualització.</p><p><b>SUGGERIMENT: </b>Deixau un comentari al canal youtube perquè el professor pugui saber que heu accedit al vídeo.</p><p>Voleu anar a youtube?</p>",e)},p.$on("$destroy",function(){B(),J(),p.deadManListener&&n.cancel(p.deadManListener);var e=v.find("iframe");e[0]&&(e[0].src="about:blank"),A&&(A.dispose(),jQuery("#"+p.playerId).empty()),pw.Sound.stop(),$("button.vjs-fullscreen-control.vjs-control.vjs-button").off(),window.pw.FScreen.setOnfullscreenchange(null)})}}}]);